<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Staff Dashboard</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='dashboard.css') }}"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css"
    />
  </head>
  <body>
    <!-- Navbar -->
    <header class="navbar">
      <div class="navbar-container">
        <a href="{{ url_for('staff.staff_dashboard') }}" class="navbar-logo"
          >STAFF</a
        >
        <div class="navbar-icons">
          <a href="#" class="navbar-icon" title="Notifications">
            <i class="fas fa-bell"></i>
            <span class="notification-badge">3</span>
          </a>
          <div class="profile-dropdown">
            <a
              href="#"
              class="navbar-icon profile-icon"
              title="Profile"
              onclick="toggleProfileMenu(event)"
            >
              <img
                src="{{ url_for('user.get_profile_picture', idno=session['IDNO']) }}"
                alt="Profile"
                class="profile-image"
              />
            </a>
            <div class="profile-dropdown-content">
              <a href="#" onclick="openModal()"
                ><i class="fas fa-user-edit"></i> Edit Profile</a
              >
              <form
                action="{{ url_for('auth.logout') }}"
                method="post"
                onsubmit="return confirmLogout(event)"
              >
                <button type="submit" class="dropdown-logout">
                  <i class="fas fa-sign-out-alt"></i> Logout
            </button>
          </form>
            </div>
          </div>
        </div>
      </div>
    </header>

    <div class="main-container">


      <div
      id="confirmDialog"
      class="confirm-dialog"
      onclick="if(event.target === this) closeConfirmDialog()"
    >
      <div class="confirm-content">
        <h3>Confirm Logout</h3>
        <p>Are you sure you want to logout?</p>
        <div class="confirm-buttons">
          <button
            onclick="handleLogout()"
            class="confirm-btn confirm-yes"
            style="background: #dd0c0c"
          >
            Yes, Logout
              </button>
          <button onclick="closeConfirmDialog()" class="confirm-btn confirm-no">
            Cancel
              </button>
            </div>
          </div>
        </div>

        <div id="editModal" class="modal">
          <div class="modal-content animate-modal">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2>Edit Profile Information</h2>
          <form
              action="{{ url_for('staff.edit_info') }}"
              method="post"
              id="editForm"
              enctype="multipart/form-data"
            >
              <div class="modal-profile-picture">
                <img
                  src="{{ url_for('user.get_profile_picture', idno=session['IDNO']) }}"
                  alt="Profile Picture"
                  class="preview-profile-image"
                />
                <div class="upload-overlay">
                  <input
                    type="file"
                    name="profile_picture"
                    id="modal-profile-upload"
                    hidden
                    accept="image/*"
                    onchange="previewImage(this)"
                  />
                  <label for="modal-profile-upload" class="upload-btn">
                    <i class="fas fa-camera"></i> Change Photo
                  </label>
                </div>
              </div>

              <div class="form-group animate-up">
                <label for="firstname">First Name:</label>
            <input
              type="text"
                  id="firstname"
                  name="firstname"
                  value="{{ staff_firstname }}"
              required
            />
              </div>
              <div class="form-group animate-up">
                <label for="lastname">Last Name:</label>
                <input
                  type="text"
                  id="lastname"
                  name="lastname"
                  value="{{ staff_lastname }}"
                  required
                />
              </div>
              <div class="form-group animate-up">
                <label for="email">Email:</label>
                <input
                  type="email"
                  id="email"
                  name="email"
                  value="{{ staff_email }}"
                  required
                />
              </div>
              <div class="form-group animate-up">
                <label for="password"
                  >New Password (leave blank to keep current):</label
                >
                <input type="password" id="password" name="password" />
              </div>
              <button type="submit" class="button pulse">
                <i class="fas fa-save"></i> Save Changes
              </button>
            </form>
          </div>
        </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast">
      <i class="fas"></i>
      <span class="toast-message"></span>
    </div>

    
      <!-- Left Panel -->
      <div class="left-panel">
        <div class="profile-header">
          <div class="profile-picture-container">
            <img
              src="{{ url_for('user.get_profile_picture', idno=session['IDNO']) }}"
              alt="Profile Picture"
              class="large-profile-image"
            />
            <button
              class="change-photo-btn"
              onclick="document.getElementById('profile-upload').click()"
            >
              <i class="fas fa-camera"></i>
            </button>
            <input
              type="file"
              id="profile-upload"
              hidden
              accept="image/*"
              onchange="previewImage(this)"
            />
          </div>
          <h1>Welcome, {{ staff_firstname }} {{ staff_lastname }}!</h1>
        </div>
        <div class="info-box">
          <p><strong>Role:</strong> Staff</p>
          <p><strong>Email:</strong> {{ staff_email }}</p>
        </div>

        <!-- Add visible Edit and Logout buttons -->
        <div class="action-buttons">
          <button class="action-button edit-button" onclick="openModal()">
            <i class="fas fa-user-edit"></i> Edit Profile
          </button>
    
        </div>

        <div class="button-container">
          <button
            class="button ripple"
            onclick="showSection('manageLabs', this)"
          >
            <i class="fas fa-desktop"></i> Manage Labs
          </button>
          <button
            class="button ripple"
            onclick="showSection('searchStudents', this)"
          >
            <i class="fas fa-search"></i> Search Students
          </button>
          <button
            class="button ripple"
            onclick="showSection('announcements', this)"
          >
            <i class="fas fa-bullhorn"></i> Manage Announcements
          </button>
          <button
            class="button ripple"
            onclick="showSection('activeSitins', this)"
          >
            <i class="fas fa-desktop"></i> Active Sit-ins
          </button>
          <button
            class="button ripple"
            onclick="showSection('sitInRecords', this)"
          >
            <i class="fas fa-history"></i> Sit-in Records
          </button>
          <button
            class="button ripple"
            onclick="showSection('statistics', this)"
          >
            <i class="fas fa-chart-pie"></i> Statistics
          </button>
          <button
            class="button ripple"
            onclick="showSection('feedbacks', this)"
          >
            <i class="fas fa-comments"></i> Student Feedbacks
          </button>
          <button
            class="button ripple"
            onclick="showSection('students', this)"
          >
            <i class="fas fa-users"></i> All Students
          </button>
          <button class="button ripple" onclick="showSection('resources', this)">
            <i class="fas fa-book"></i> Lab Resources
          </button>
          <button class="button ripple" onclick="showSection('labSchedule', this)">
            <i class="fas fa-clock"></i> Lab Schedule
          </button>
          <button class="button ripple" onclick="showSection('rewards', this)">
            <i class="fas fa-trophy"></i> Rewards & Points
          </button>
          <form
            action="{{ url_for('auth.logout') }}"
            method="post"
            onsubmit="return confirmLogout(event)"
            class="logout-form"
          >
            <button type="submit" class="button ripple logout-button">
              <i class="fas fa-sign-out-alt"></i> Logout
            </button>
          </form>
        </div>
      </div>

      <!-- Right Panel -->
      <div class="right-panel">
        <!-- Edit Profile Modal -->
        
        <!-- Manage Labs Section -->
        <div id="manageLabs" class="content-section animate-section">
          <h2><i class="fas fa-desktop"></i> Manage Labs</h2>
          <div class="card-container">
            <div class="card labs-list-card">
              <div class="header-with-button">
                <h3><i class="fas fa-list"></i> Existing Labs</h3>
                <button class="add-btn pulse-hover" onclick="openAddLabModal()">
                  <i class="fas fa-plus"></i> Add New Lab
                </button>
              </div>
              <div class="data-container custom-scrollbar">
                <div id="labList" class="grid-list"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Add Lab Modal -->
        <div id="addLabModal" class="modal">
          <div class="modal-content animate-modal">
            <span class="close" onclick="closeAddLabModal()">&times;</span>
            <h2><i class="fas fa-plus-circle"></i> Add New Lab</h2>
            <form id="addLabForm">
              <div class="form-group animate-up">
                <label for="labId">Lab Name/ID</label>
                <input
                  type="text"
                  id="labId"
                  name="labId"
                  required
                  placeholder="e.g., LAB-101"
                />
                <span class="focus-border"></span>
              </div>
              <div class="form-group animate-up">
                <label for="totalComputers">Total Computers</label>
                <input
                  type="number"
                  id="totalComputers"
                  name="totalComputers"
                  required
                  min="1"
                  placeholder="Enter number of computers"
                />
                <span class="focus-border"></span>
              </div>
              <button type="submit" class="submit-btn pulse-hover">
                <i class="fas fa-plus"></i> Add Lab
              </button>
            </form>
          </div>
        </div>

        <!-- Active Sit-ins Section -->
        <div id="activeSitins" class="content-section animate-section">
            <h2><i class="fas fa-desktop"></i> Active Sit-ins</h2>
            
            <!-- Statistics Section -->
            <div class="active-stats">
                <!-- Will be populated dynamically -->
            </div>

            <!-- Filters -->
            <div class="filters-container">
                <div class="filter-group">
                    <label for="activeFilterLab">Filter by Lab:</label>
                    <select id="activeFilterLab" class="custom-select" onchange="loadActiveSessions()">
                        <option value="">All Labs</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="activeFilterPurpose">Filter by Purpose:</label>
                    <select id="activeFilterPurpose" class="custom-select" onchange="loadActiveSessions()">
                        <option value="">All Purposes</option>
                    </select>
                </div>
            </div>

            <!-- Active Sessions Grid -->
            <div class="active-sessions-grid">
                <!-- Will be populated dynamically -->
            </div>

            <h3 class="section-subtitle"><i class="fas fa-history"></i> Today's Ended Sessions</h3>
            <div class="ended-sessions-grid">
                <!-- Will be populated dynamically -->
            </div>
        </div>

        <!-- Search Students Section -->
        <div id="searchStudents" class="content-section" style="display: none">
          <h2><i class="fas fa-search"></i> Search Students</h2>
          <div class="card-container">
            <div class="card search-card">
              <form class="search-form">
                <div class="search-group">
                  <input
                    type="text"
                    id="studentId"
                    name="studentId"
                    required
                    placeholder="Enter Student ID"
                  />
                  <button type="submit" class="search-btn pulse-hover">
                    <i class="fas fa-search"></i>
                  </button>
                </div>
              </form>
              <div class="results-container custom-scrollbar">
                <table class="student-table">
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Name</th>
                      <th>Course</th>
                      <th>Year</th>
                      <th>Email</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="searchResults"></tbody>
                </table>
                <div id="noResults" class="no-results" style="display: none">
                  <i class="fas fa-user-slash"></i>
                  <p>No student found with that ID</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Add Sit-in Records Section -->
        <div id="sitInRecords" class="content-section" style="display: none">
          <h2><i class="fas fa-history"></i> Sit-in Records</h2>
          <div class="card-container">
            <div class="card">
              <div class="filters-container">
                <div class="filter-group">
                  <label for="recordFilterLab">Filter by Lab:</label>
                  <select id="recordFilterLab" class="custom-select" onchange="filterRecords()">
                    <option value="">All Labs</option>
                  </select>
                </div>
                <div class="filter-group">
                  <label for="recordFilterPurpose">Filter by Purpose:</label>
                  <select id="recordFilterPurpose" class="custom-select" onchange="filterRecords()">
                    <option value="">All Purposes</option>
                  </select>
                </div>
                <div class="filter-group">
                  <label for="recordFilterStatus">Filter by Status:</label>
                  <select id="recordFilterStatus" class="custom-select" onchange="filterRecords()">
                    <option value="">All Statuses</option>
                    <option value="PENDING">Pending</option>
                    <option value="APPROVED">Approved</option>
                    <option value="DENIED">Denied</option>
                  </select>
                </div>
                <div class="filter-group">
                  <label for="recordFilterSession">Filter by Session:</label>
                  <select id="recordFilterSession" class="custom-select" onchange="filterRecords()">
                    <option value="">All Sessions</option>
                    <option value="ON_GOING">Ongoing</option>
                    <option value="ENDED">Ended</option>
                  </select>
                </div>
                <div class="filter-group">
                  <label for="reportFormat">Report Format:</label>
                  <select id="reportFormat" class="custom-select">
                    <option value="excel">Excel (.xlsx)</option>
                    <option value="csv">CSV</option>
                    <option value="pdf">PDF</option>
                  </select>
                  <button onclick="generateReport()" class="generate-report-btn">
                    <i class="fas fa-download"></i> Generate Report
                  </button>
                </div>
              </div>
              <div class="records-grid custom-scrollbar">
                <!-- Records will be populated dynamically -->
              </div>
            </div>
          </div>
        </div>

        <!-- Announcements Section -->
        <div id="announcements" class="content-section" style="display: none">
          <h2><i class="fas fa-bullhorn"></i> Manage Announcements</h2>
          <div class="card-container">
            <div class="card announcements-list-card">
              <div class="header-with-button">
                <h3><i class="fas fa-list"></i> Posted Announcements</h3>
                <button
                  class="add-btn pulse-hover"
                  onclick="openAddAnnouncementModal()"
                >
                  <i class="fas fa-plus"></i> New Announcement
                </button>
              </div>
              <div
                class="data-container custom-scrollbar"
                id="announcementsList"
              ></div>
            </div>
          </div>
        </div>

        <div id="feedbacks" class="content-section animate-section" style="display: none">
          <h2><i class="fas fa-comments"></i> Student Feedbacks</h2>
          <div class="card-container">
            <div class="card">
              <div class="filters-container">
                <div class="filter-group">
                  <label for="feedbackReportFormat">Report Format:</label>
                  <select id="feedbackReportFormat" class="custom-select">
                    <option value="excel">Excel (.xlsx)</option>
                    <option value="csv">CSV</option>
                    <option value="pdf">PDF</option>
                  </select>
                  <button onclick="generateReport()" class="generate-report-btn">
                    <i class="fas fa-download"></i> Generate Report
                  </button>
                </div>
              </div>
              <div class="feedbacks-container custom-scrollbar">
                <!-- Feedbacks will be populated here -->
              </div>
            </div>
          </div>
        </div>


        <!-- Statistics Section -->
        <div id="statistics" class="content-section animate-section" style="display: none">
            <h2><i class="fas fa-chart-pie"></i> System Statistics</h2>
            <div class="card-container">
                <div class="card">
                    <div class="statistics-container">
                        <div class="report-controls">
                            <div class="filter-group">
                                <label for="statisticsReportFormat">Report Format:</label>
                                <select id="statisticsReportFormat" class="custom-select">
                                    <option value="excel">Excel (.xlsx)</option>
                                    <option value="csv">CSV</option>
                                    <option value="pdf">PDF</option>
                                </select>
                            </div>
                            <button onclick="generateReport()" class="generate-report-btn">
                                <i class="fas fa-download"></i> Generate Report
                            </button>
                        </div>
                        <div class="stats-cards">
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="fas fa-users"></i>
                                </div>
                                <div class="stat-info">
                                    <h3>Registered Students</h3>
                                    <p id="registeredStudents">0</p>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="fas fa-desktop"></i>
                                </div>
                                <div class="stat-info">
                                    <h3>Current Sit-ins</h3>
                                    <p id="currentSitins">0</p>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="fas fa-history"></i>
                                </div>
                                <div class="stat-info">
                                    <h3>Total Sit-ins</h3>
                                    <p id="totalSitins">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="charts-container">
                            <div class="chart-card">
                                <h3>Sit-ins by Purpose</h3>
                                <canvas id="purposeChart"></canvas>
                            </div>
                            <div class="chart-card">
                                <h3>Sit-ins by Laboratory</h3>
                                <canvas id="labChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add this inside the statistics section -->
        <div class="stat-card">
          <h3><i class="fas fa-trophy"></i> Top 5 Students</h3>
          <div id="topStudentsList" class="top-students-list">
            <!-- Top students will be loaded here -->
          </div>
        </div>

        <style>
          .stat-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
          }
          
          /* Add more spacing between chart and top students */
          .chart-container {
            margin-bottom: 50px; /* Increased spacing */
          }
          
          .top-students-container {
            margin-top: 40px; /* Added top margin */
            padding-top: 20px; /* Added padding */
            border-top: 1px solid rgba(255, 255, 255, 0.1); /* Optional: adds a subtle separator */
          }
          
          .top-students-list {
            margin-top: 20px;
          }
          
          .top-student-item {
            display: flex;
            align-items: center;
            padding: 15px; /* Increased padding */
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            margin-bottom: 15px; /* Increased spacing between items */
            transition: transform 0.2s ease;
          }
          
          .top-student-item:hover {
            transform: translateX(5px);
            background: rgba(255, 255, 255, 0.1);
          }
          
          .top-student-rank {
            font-size: 1.4em; /* Increased font size */
            font-weight: bold;
            color: #ffd700;
            margin-right: 20px; /* Increased margin */
            min-width: 40px; /* Fixed width for ranks */
            text-align: center;
          }
          
          .top-student-info {
            flex-grow: 1;
            margin-right: 20px; /* Added margin */
          }
          
          .top-student-name {
            font-weight: bold;
            color: #fff;
            font-size: 1.1em; /* Increased font size */
            margin-bottom: 5px; /* Added margin */
          }
          
          .top-student-course {
            font-size: 0.9em;
            color: #ccc;
          }
          
          .top-student-sitins {
            font-weight: bold;
            color: #4CAF50;
            font-size: 1.1em; /* Increased font size */
            background: rgba(76, 175, 80, 0.1);
            padding: 5px 10px;
            border-radius: 5px;
          }
        </style>

        <script>
          // Add this function to load top students
          function loadTopStudents() {
            console.log('Loading top students...'); // Debug log
            fetch('/staff/top_students')
              .then(response => {
                console.log('Response status:', response.status); // Debug log
                return response.json();
              })
              .then(students => {
                console.log('Received students:', students); // Debug log
                const topStudentsList = document.getElementById('topStudentsList');
                if (!topStudentsList) {
                  console.error('topStudentsList element not found!'); // Debug log
                  return;
                }
                
                topStudentsList.innerHTML = '';
                
                if (students.length === 0) {
                  topStudentsList.innerHTML = '<div class="no-data">No student data available</div>';
                  return;
                }
                
                students.forEach((student, index) => {
                  console.log('Processing student:', student); // Debug log
                  const studentElement = document.createElement('div');
                  studentElement.className = 'top-student-item';
                  studentElement.innerHTML = `
                    <div class="top-student-rank">#${index + 1}</div>
                    <div class="top-student-info">
                      <div class="top-student-name">${student.student_name}</div>
                      <div class="top-student-course">${student.course}</div>
                    </div>
                    <div class="top-student-sitins">
                      ${student.total_sitins} sit-ins
                    </div>
                  `;
                  topStudentsList.appendChild(studentElement);
                });
              })
              .catch(error => {
                console.error('Error loading top students:', error);
                showToast('Error loading top students', 'error');
              });
          }

          // Update the loadStatistics function
          function loadStatistics() {
            console.log('Loading statistics...'); // Debug log
            // ... existing statistics loading code ...
            
            // Load top students
            loadTopStudents();
          }

          // Make sure loadStatistics is called when the page loads
          document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing statistics...'); // Debug log
            loadStatistics();
          });
        </script>

        
        <!-- All Students Section -->
        <div id="students" class="content-section animate-section" style="display: none">
          <h2><i class="fas fa-users"></i> All Students</h2>
          <div class="card-container">
            <div class="card">
              <div class="header-with-button">
                <h3>Student Management</h3>
                <button onclick="confirmResetAllSessions()" class="reset-all-btn">
                  <i class="fas fa-redo"></i> Reset All Sessions
                </button>
              </div>
              <div class="filters-container">
                <div class="filter-group">
                  <label for="studentReportFormat">Report Format:</label>
                  <select id="studentReportFormat" class="custom-select">
                    <option value="excel">Excel (.xlsx)</option>
                    <option value="csv">CSV</option>
                    <option value="pdf">PDF</option>
                  </select>
                  <button onclick="generateStudentReport()" class="generate-report-btn">
                    <i class="fas fa-download"></i> Generate Report
                  </button>
                </div>
              </div>
              <div class="students-container custom-scrollbar">
                <table class="student-table">
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Name</th>
                      <th>Course</th>
                      <th>Year</th>
                      <th>Email</th>
                      <th>Remaining Sessions</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="studentsList">
                    <!-- Students will be populated here -->
                  </tbody>
                </table>
                <div id="noStudents" class="no-results" style="display: none">
                  <i class="fas fa-user-slash"></i>
                  <p>No students found</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Add this to your existing style section -->
        <style>
        .students-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            padding: 20px;
            max-height: 600px;
            overflow-y: auto;
        }

        .student-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            transition: transform 0.3s ease;
        }

        .student-card:hover {
            transform: translateY(-5px);
        }

        .student-info {
            display: flex;
            gap: 15px;
        }

        .student-profile-pic {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
        }

        .student-details {
            flex: 1;
        }

        .student-details h3 {
            margin: 0 0 10px 0;
            color: #fff;
        }

        .student-details p {
            margin: 5px 0;
            color: #ccc;
        }

        .student-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: flex-end;
        }

        .header-with-button {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .filter-container {
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            margin: 20px;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #ccc;
        }

        .no-data i {
            font-size: 48px;
            margin-bottom: 15px;
            color: #45a049;
        }
        </style>
        
        <!-- Lab Schedule Section -->
        <div id="labSchedule" class="content-section">
          <h2><i class="fas fa-clock"></i> Lab Schedule</h2>
          <div class="schedule-container">
            <div class="schedule-actions">
              <button class="action-button" onclick="showAddScheduleModal()">
                <i class="fas fa-plus"></i> Add Schedule
              </button>
            </div>
            <div class="schedule-grid" id="scheduleList">
              <!-- Schedule items will be populated here -->
            </div>
          </div>
        </div>

        <!-- Rewards Section -->
        <div id="rewards" class="content-section">
          <h2><i class="fas fa-trophy"></i> Rewards & Points</h2>
          <div class="rewards-container">
            <div class="rewards-actions">
              <button class="action-button" onclick="showAddRewardModal()">
                <i class="fas fa-plus"></i> Add Reward
              </button>
            </div>
            <div class="top-participants">
              <h3>Top 5 Participants</h3>
              <div class="participants-list" id="topParticipantsList">
                <!-- Top participants will be populated here -->
              </div>
            </div>
          </div>
        </div>

        <!-- Add Schedule Modal -->
        <div id="addScheduleModal" class="modal">
          <div class="modal-content">
            <span class="close" onclick="closeAddScheduleModal()">&times;</span>
            <h2>Add Lab Schedule</h2>
            <form id="addScheduleForm">
              <div class="form-group">
                <label for="labSelect">Laboratory:</label>
                <select id="labSelect" required>
                  <!-- Labs will be populated here -->
                </select>
              </div>
              <div class="form-group">
                <label for="daySelect">Day:</label>
                <select id="daySelect" required>
                  <option value="Monday">Monday</option>
                  <option value="Tuesday">Tuesday</option>
                  <option value="Wednesday">Wednesday</option>
                  <option value="Thursday">Thursday</option>
                  <option value="Friday">Friday</option>
                </select>
              </div>
              <div class="form-group">
                <label for="startTime">Start Time:</label>
                <input type="time" id="startTime" required>
              </div>
              <div class="form-group">
                <label for="endTime">End Time:</label>
                <input type="time" id="endTime" required>
              </div>
              <div class="form-group">
                <label for="subject">Subject:</label>
                <input type="text" id="subject" required>
              </div>
              <div class="form-group">
                <label for="instructor">Instructor:</label>
                <input type="text" id="instructor" required>
              </div>
              <button type="submit" class="action-button">Add Schedule</button>
            </form>
          </div>
        </div>

        <!-- Add Reward Modal -->
        <div id="addRewardModal" class="modal">
          <div class="modal-content">
            <span class="close" onclick="closeAddRewardModal()">&times;</span>
            <h2>Add Reward</h2>
            <form id="addRewardForm">
              <div class="form-group">
                <label for="studentSelect">Student:</label>
                <select id="studentSelect" required>
                  <!-- Students will be populated here -->
                </select>
              </div>
              <div class="form-group">
                <label for="rewardType">Reward Type:</label>
                <select id="rewardType" required>
                  <option value="ATTENDANCE">Attendance</option>
                  <option value="PARTICIPATION">Participation</option>
                  <option value="ACHIEVEMENT">Achievement</option>
                </select>
              </div>
              <div class="form-group">
                <label for="points">Points:</label>
                <input type="number" id="points" min="1" required>
              </div>
              <div class="form-group">
                <label for="description">Description:</label>
                <textarea id="description" required></textarea>
              </div>
              <button type="submit" class="action-button">Add Reward</button>
            </form>
          </div>
        </div>
        <!-- Add this new section -->
        <div id="resources" class="content-section">
          <div class="header-with-button">
            <h2><i class="fas fa-book"></i> Lab Resources</h2>
            <button class="add-btn" onclick="openAddResourceModal()">
              <i class="fas fa-plus"></i> Add Resource
            </button>
          </div>

          <div class="resources-container">
            <div class="resources-grid" id="resourcesList">
              <!-- Resources will be populated here -->
            </div>
          </div>
        </div>

      
        

        <div id="sitInHistory" class="content-section animate-section" style="display: none">
          <h2><i class="fas fa-history"></i> Sit-in History</h2>
          <div class="card-container">
            <div class="card">
              <div class="filters-container">
                <div class="filter-group">
                  <label for="recordFilterLab">Filter by Lab:</label>
                  <select id="recordFilterLab" class="custom-select">
                    <option value="">All Labs</option>
                  </select>
                </div>
                <div class="filter-group">
                  <label for="recordFilterPurpose">Filter by Purpose:</label>
                  <select id="recordFilterPurpose" class="custom-select">
                    <option value="">All Purposes</option>
                  </select>
                </div>
                <div class="filter-group">
                  <label for="recordFilterStatus">Filter by Status:</label>
                  <select id="recordFilterStatus" class="custom-select">
                    <option value="">All Statuses</option>
                    <option value="PENDING">Pending</option>
                    <option value="APPROVED">Approved</option>
                    <option value="DENIED">Denied</option>
                  </select>
                </div>
                <div class="filter-group">
                  <label for="recordFilterSession">Filter by Session:</label>
                  <select id="recordFilterSession" class="custom-select">
                    <option value="">All Sessions</option>
                    <option value="ON_GOING">Ongoing</option>
                    <option value="ENDED">Ended</option>
                  </select>
                </div>
                <div class="filter-group">
                  <label for="historyReportFormat">Report Format:</label>
                  <select id="historyReportFormat" class="custom-select">
                    <option value="excel">Excel (.xlsx)</option>
                    <option value="csv">CSV</option>
                    <option value="pdf">PDF</option>
                  </select>
                  <button onclick="generateHistoryReport()" class="generate-report-btn">
                    <i class="fas fa-download"></i> Generate Report
                  </button>
                </div>
              </div>
              <div class="records-grid custom-scrollbar">
                <!-- Records will be populated dynamically -->
              </div>
            </div>
          </div>
        </div>

     
        <!-- Add Announcement Modal -->
        <div id="addAnnouncementModal" class="modal">
          <div class="modal-content animate-modal">
            <span class="close" onclick="closeAddAnnouncementModal()"
              >&times;</span
            >
            <h2><i class="fas fa-bullhorn"></i> New Announcement</h2>
            <form id="announcementForm">
              <div class="form-group animate-up">
                <label for="title">Title</label>
                <input
                  type="text"
                  id="title"
                  name="title"
                  required
                  placeholder="Enter announcement title"
                />
                <span class="focus-border"></span>
              </div>
              <div class="form-group animate-up">
                <label for="content">Content</label>
            <textarea
                  id="content"
                  name="content"
                  rows="4"
              required
                  placeholder="Enter announcement content"
            ></textarea>
                <span class="focus-border"></span>
              </div>
              <button type="submit" class="submit-btn pulse-hover">
                <i class="fas fa-paper-plane"></i> Post Announcement
              </button>
          </form>
          </div>
        </div>


        <!-- Edit Announcement Modal -->
        <div id="editAnnouncementModal" class="modal">
          <div class="modal-content">
            <div class="modal-header">
              <h3>Edit Announcement</h3>
            </div>
            <div class="modal-body">
          <form id="editAnnouncementForm">
            <input type="hidden" id="editAnnouncementId" />
              <input
                type="text"
                id="editAnnouncementTitle"
                placeholder="Title"
                required
              />
              <textarea
                id="editAnnouncementContent"
                placeholder="Content"
                required
              ></textarea>
            <button type="submit">Update Announcement</button>
          </form>
            </div>
          </div>
        </div>

    <!-- Image Cropper Modal -->
    <div id="cropperModal" class="cropper-modal">
      <div class="cropper-container">
        <span class="close" onclick="closeCropperModal()">&times;</span>
        <div id="cropperArea">
          <img id="cropperImage" src="" alt="Image to crop" />
        </div>
        <div class="cropper-buttons">
          <button class="cropper-btn save" onclick="saveCroppedImage()">
            Save
              </button>
          <button class="cropper-btn cancel" onclick="closeCropperModal()">
            Cancel
              </button>
            </div>
          </div>
        </div>

    <!-- Custom Confirmation Dialog -->
  

    <!-- End Session Modal -->
    <div
      id="endSessionModal"
      class="confirm-dialog"
      onclick="if(event.target === this) closeEndSessionModal()"
    >
      <div class="confirm-content">
        <h3><i class="fas fa-sign-out-alt"></i> End Sit-in Session</h3>
        <div class="student-info-end">
          <img
            src=""
            alt="Student"
            id="endSessionStudentImg"
            class="student-profile-pic"
          />
          <div class="student-details">
            <h4 id="endSessionStudentName"></h4>
            <p id="endSessionDetails"></p>
          </div>
        </div>
        <p class="confirmation-message">
          Are you sure you want to end this student's sit-in session?
        </p>
        <div class="confirm-buttons">
          <button onclick="confirmEndSession()" class="confirm-btn confirm-yes">
            <i class="fas fa-check"></i> Yes, End Session
              </button>
          <button
            onclick="closeEndSessionModal()"
            class="confirm-btn confirm-no"
          >
            <i class="fas fa-times"></i> Cancel
              </button>
            </div>
          </div>
        </div>

    <!-- Add Sit-in Modal -->
    <div id="sitInModal" class="modal">
      <div class="modal-content compact-modal">
        <span class="close" onclick="closeSitInModal()">&times;</span>
        <div class="modal-header">
          <h2><i class="fas fa-sign-in-alt"></i> Start Sit-in</h2>
            </div>
        <form id="sitInForm" onsubmit="startSitIn(event)">
          <input type="hidden" id="sitInStudentId" />
          <div class="student-info">
            <h3 id="sitInStudentName"></h3>
          </div>
          <div class="form-group-compact">
            <select id="sitInLab" required>
              <option value="">Select Lab</option>
            </select>
        </div>
          <div class="form-group-compact">
            <select id="sitInPurpose" required>
              <option value="">Select Purpose</option>
            </select>
          </div>
          <button type="submit" class="submit-btn">
            <i class="fas fa-sign-in-alt"></i> Start Session
          </button>
        </form>
      </div>
    </div>

    <!-- Add Resource Modal -->
    <div id="addResourceModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeAddResourceModal()">&times;</span>
        <h2><i class="fas fa-plus"></i> Add New Resource</h2>
        
        <form id="addResourceForm" onsubmit="submitResource(event)">
          <div class="form-group">
            <label for="title">Title</label>
            <input type="text" id="title" name="title" required>
          </div>
          
          <div class="form-group">
            <label for="description">Description</label>
            <textarea id="description" name="description" required></textarea>
          </div>
          
          <div class="form-group">
            <label for="resourceType">Resource Type</label>
            <select id="resourceType" name="resource_type" onchange="toggleResourceInputs()" required>
              <option value="">Select Type</option>
              <option value="FILE">File Upload</option>
              <option value="LINK">External Link</option>
              <option value="TEXT">Plain Text</option>
            </select>
          </div>
          
          <div id="fileInput" class="form-group" style="display: none;">
            <label for="file">Upload File</label>
            <input type="file" id="file" name="file">
            <small>Allowed formats: PDF, DOC, DOCX, PPT, PPTX, TXT, ZIP, RAR</small>
          </div>
          
          <div id="linkInput" class="form-group" style="display: none;">
            <label for="contentUrl">External Link</label>
            <input type="url" id="contentUrl" name="content_url">
          </div>
          
          <div id="textInput" class="form-group" style="display: none;">
            <label for="contentText">Content</label>
            <textarea id="contentText" name="content_text"></textarea>
          </div>
          
          <div class="form-group">
            <label for="courses">Target Courses</label>
            <select id="courses" name="courses[]" multiple required>
              <!-- Courses will be populated dynamically -->
            </select>
            <small>Hold Ctrl/Cmd to select multiple courses</small>
          </div>
          
          <div class="form-actions">
            <button type="submit" class="submit-btn">
              <i class="fas fa-save"></i> Save Resource
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Edit Resource Modal -->
    <div id="editResourceModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeEditResourceModal()">&times;</span>
        <h2><i class="fas fa-edit"></i> Edit Resource</h2>
        
        <form id="editResourceForm" onsubmit="updateResource(event)">
          <input type="hidden" id="editResourceId">
          <div class="form-group">
            <label for="editTitle">Title</label>
            <input type="text" id="editTitle" name="title" required>
          </div>
          
          <div class="form-group">
            <label for="editDescription">Description</label>
            <textarea id="editDescription" name="description" required></textarea>
          </div>
          
          <div class="form-group">
            <label for="editResourceType">Resource Type</label>
            <select id="editResourceType" name="resource_type" onchange="toggleEditResourceInputs()" required>
              <option value="">Select Type</option>
              <option value="FILE">File Upload</option>
              <option value="LINK">External Link</option>
              <option value="TEXT">Plain Text</option>
            </select>
          </div>
          
          <div id="editFileInput" class="form-group" style="display: none;">
            <label for="editFile">Upload File</label>
            <input type="file" id="editFile" name="file">
            <small>Allowed formats: PDF, DOC, DOCX, PPT, PPTX, TXT, ZIP, RAR</small>
          </div>
          
          <div id="editLinkInput" class="form-group" style="display: none;">
            <label for="editContentUrl">External Link</label>
            <input type="url" id="editContentUrl" name="content_url">
          </div>
          
          <div id="editTextInput" class="form-group" style="display: none;">
            <label for="editContentText">Content</label>
            <textarea id="editContentText" name="content_text"></textarea>
          </div>
          
          <div class="form-group">
            <label for="editCourses">Target Courses</label>
            <select id="editCourses" name="courses[]" multiple required>
              <!-- Courses will be populated dynamically -->
            </select>
            <small>Hold Ctrl/Cmd to select multiple courses</small>
          </div>
          
          <div class="form-actions">
            <button type="submit" class="submit-btn">
              <i class="fas fa-save"></i> Update Resource
            </button>
          </div>
        </form>
      </div>
    </div>

    <style>
      /* Card Styles */
      .card-container {
        display: grid;
        gap: 20px;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        margin-top: 20px;
      }

      .card {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
      }

      .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2);
      }

      .card h3 {
        color: #fff;
        margin-bottom: 20px;
        font-size: 1.2em;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      /* Form Styles */
      .form-group {
        position: relative;
        margin-bottom: 20px;
      }

      .form-group input,
      .form-group textarea {
        width: 100%;
        padding: 10px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        color: #fff;
        font-size: 16px;
        transition: all 0.3s ease;
      }

      .form-group input:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: #45a049;
        box-shadow: 0 0 0 2px rgba(69, 160, 73, 0.2);
      }

      .focus-border {
        position: absolute;
        bottom: 0;
        left: 50%;
        width: 0;
        height: 2px;
        background-color: #45a049;
        transition: all 0.3s ease;
      }

      .form-group input:focus ~ .focus-border,
      .form-group textarea:focus ~ .focus-border {
        width: 100%;
        left: 0;
      }

      /* Button Styles */
      .submit-btn,
      .search-btn {
        width: 100%;
        padding: 12px;
        background: linear-gradient(135deg, #45a049 0%, #33833b 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
      }

      .pulse-hover:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(69, 160, 73, 0.4);
        animation: pulse 1s infinite;
      }

      @keyframes pulse {
        0% {
          box-shadow: 0 0 0 0 rgba(69, 160, 73, 0.4);
        }
        70% {
          box-shadow: 0 0 0 10px rgba(69, 160, 73, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(69, 160, 73, 0);
        }
      }

      /* Search Styles */
      .search-group {
        display: flex;
        gap: 10px;
      }

      .search-group input {
        flex: 1;
      }

      .search-btn {
        width: auto;
        padding: 12px 20px;
      }

      /* Table Styles */
      .student-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0 8px;
        margin-top: 20px;
      }

      .student-table th,
      .student-table td {
        padding: 12px;
        text-align: left;
        background: rgba(255, 255, 255, 0.1);
      }

      .student-table th {
        background: rgba(0, 0, 0, 0.3);
        font-weight: 600;
      }

      .student-table tr {
        transition: transform 0.3s ease;
      }

      .student-table tbody tr:hover {
        transform: translateX(5px);
        background: rgba(255, 255, 255, 0.15);
      }

      /* Lab List Styles */
      .grid-list {
        display: grid;
        gap: 15px;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      }

      .lab-item {
        background: rgba(255, 255, 255, 0.1);
        padding: 15px;
        border-radius: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.3s ease;
      }

      .lab-item:hover {
        transform: translateX(5px);
        background: rgba(255, 255, 255, 0.15);
      }

      .lab-info {
        flex: 1;
      }

      .lab-actions button {
        background: #dd0c0c;
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .lab-actions button:hover {
        background: #ff4444;
        transform: translateY(-2px);
      }

      /* Announcement Styles */
      .announcement-item {
        background: rgba(255, 255, 255, 0.1);
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
        transition: all 0.3s ease;
      }

      .announcement-item:hover {
        transform: translateX(5px);
        background: rgba(255, 255, 255, 0.15);
      }

      .announcement-actions {
        display: flex;
        gap: 10px;
        margin-top: 10px;
      }

      .announcement-actions button {
        padding: 8px 15px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .announcement-actions button.edit {
        background: #4a90e2;
        color: white;
      }

      .announcement-actions button.delete {
        background: #dd0c0c;
        color: white;
      }

      .announcement-actions button:hover {
        transform: scale(1.05);
      }

      /* Custom Scrollbar */
      .custom-scrollbar {
        max-height: 500px;
        overflow-y: auto;
        padding-right: 10px;
      }

      .custom-scrollbar::-webkit-scrollbar {
        width: 8px;
      }

      .custom-scrollbar::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 4px;
      }

      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.3);
        border-radius: 4px;
      }

      .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.4);
      }

      /* No Results State */
      .no-results {
        text-align: center;
        padding: 40px 20px;
        color: rgba(255, 255, 255, 0.7);
      }

      .no-results i {
        font-size: 48px;
        margin-bottom: 15px;
      }

      /* Confirmation Dialog */
      .confirm-dialog {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(5px);
        z-index: 1000;
        justify-content: center;
        align-items: center;
      }

      .confirm-content {
        background: linear-gradient(
          135deg,
          rgba(40, 44, 52, 0.95) 0%,
          rgba(25, 29, 37, 0.95) 100%
        );
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        max-width: 400px;
        width: 90%;
        text-align: center;
        transform: scale(0.9);
        opacity: 0;
        animation: confirmShow 0.3s ease forwards;
      }

      @keyframes confirmShow {
        to {
          transform: scale(1);
          opacity: 1;
        }
      }

      .confirm-buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-top: 20px;
      }

      .confirm-btn {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        transition: all 0.3s ease;
      }

      .confirm-yes {
        background: #dd0c0c;
        color: white;
      }

      .confirm-no {
        background: #45a049;
        color: white;
      }

      .confirm-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }

      /* Student Profile Picture */
      .student-profile-pic {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        margin-right: 10px;
        vertical-align: middle;
        object-fit: cover;
      }

      .announcement-meta {
        margin: 10px 0;
        color: rgba(255, 255, 255, 0.7);
      }

      .announcement-actions {
        margin-top: 15px;
        display: flex;
        gap: 10px;
      }

      .announcement-actions button {
        padding: 8px 15px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 5px;
        transition: all 0.3s ease;
      }

      .announcement-actions button.edit {
        background: #4a90e2;
        color: white;
      }

      .announcement-actions button.delete {
        background: #dd0c0c;
        color: white;
      }

      .announcement-actions button:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }

      /* Add these new styles */
      .header-with-button {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .add-btn {
        background: #45a049;
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 5px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 14px;
        transition: all 0.3s ease;
      }

      .add-btn:hover {
        background: #33833b;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(69, 160, 73, 0.4);
      }

      /* Toast Notification */
      .toast {
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 15px 25px;
        background: rgba(0, 0, 0, 0.9);
        color: white;
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 10px;
        transform: translateY(100px);
        opacity: 0;
        transition: all 0.3s ease;
        z-index: 2000;
      }

      .toast.show {
        transform: translateY(0);
        opacity: 1;
      }

      .toast.success {
        border-left: 4px solid #45a049;
      }

      .toast.error {
        border-left: 4px solid #dd0c0c;
      }

      /* Add or update these styles */
      .modal-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        padding: 30px;
      }

      .modal-profile-picture {
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-bottom: 30px;
      }

      .preview-profile-image {
        width: 150px;
        height: 150px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid #fff;
        margin-bottom: 15px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      }

      .upload-overlay {
        margin-top: 15px;
        text-align: center;
      }

      .upload-btn {
        background: #4a90e2;
        color: white;
        padding: 10px 20px;
        border-radius: 25px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .upload-btn:hover {
        background: #357abd;
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(74, 144, 226, 0.4);
      }

      #editForm {
        width: 100%;
        max-width: 400px;
        margin-top: 20px;
      }

      .form-group {
        text-align: left;
        margin-bottom: 15px;
      }

      .modal h2 {
        width: 100%;
        text-align: center;
        margin-bottom: 20px;
      }

      .close {
        position: absolute;
        right: 20px;
        top: 20px;
        font-size: 24px;
        cursor: pointer;
        color: #fff;
        transition: color 0.3s ease;
      }

      .close:hover {
        color: #ff4444;
      }

      /* Add these styles for the edit announcement modal */
      #editAnnouncementModal .modal-content {
        max-width: 600px;
        width: 90%;
        padding: 30px;
        border-radius: 15px;
        background: linear-gradient(
          135deg,
          rgba(40, 44, 52, 0.95) 0%,
          rgba(25, 29, 37, 0.95) 100%
        );
      }

      #editAnnouncementModal .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      #editAnnouncementModal .modal-header h3 {
        margin: 0;
        color: #fff;
      }

      #editAnnouncementModal .close-modal {
        font-size: 24px;
        color: #fff;
        cursor: pointer;
        transition: color 0.3s ease;
      }

      #editAnnouncementModal .close-modal:hover {
        color: #ff4444;
      }

      #editAnnouncementModal input[type="text"],
      #editAnnouncementModal textarea {
        width: 100%;
        padding: 12px;
        margin-bottom: 15px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        color: #fff;
        font-size: 16px;
        transition: all 0.3s ease;
      }

      #editAnnouncementModal textarea {
        min-height: 150px;
        resize: vertical;
      }

      #editAnnouncementModal input[type="text"]:focus,
      #editAnnouncementModal textarea:focus {
        outline: none;
        border-color: #45a049;
        box-shadow: 0 0 0 2px rgba(69, 160, 73, 0.2);
      }

      #editAnnouncementModal button[type="submit"] {
        width: 100%;
        padding: 12px;
        background: linear-gradient(135deg, #45a049 0%, #33833b 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
      }

      #editAnnouncementModal button[type="submit"]:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(69, 160, 73, 0.4);
      }

      /* Active Sessions Styling */
      .section-header {
        margin-bottom: 20px;
      }

      .section-header h2 {
        color: #fff;
        font-size: 1.5em;
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 0;
      }

      .filters-container {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
        background: rgba(255, 255, 255, 0.1);
        padding: 20px;
        border-radius: 15px;
        backdrop-filter: blur(10px);
      }

      .filter-group {
        flex: 1;
      }

      .filter-group label {
        display: block;
        margin-bottom: 8px;
        color: #fff;
        font-weight: 500;
      }

      .custom-select {
        width: 100%;
        padding: 12px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        color: #fff;
        font-size: 16px;
        transition: all 0.3s ease;
      }

      .custom-select:focus {
        outline: none;
        border-color: #45a049;
        box-shadow: 0 0 0 2px rgba(69, 160, 73, 0.2);
      }

      .custom-select option {
        background: #2c3038;
        color: #fff;
      }

      /* Update the active sessions grid styles */
      .active-sessions-grid {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        margin: 0;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        align-content: start;
      }

      /* Add styles for empty state */
      .no-sessions {
        text-align: center;
        padding: 40px;
        color: rgba(255, 255, 255, 0.7);
      }

      .no-sessions i {
        font-size: 48px;
        margin-bottom: 15px;
        display: block;
      }

      .no-sessions p {
        font-size: 16px;
        margin: 0;
      }

      /* Start Sit-in Button Style */
      .start-sitin-btn {
        background: linear-gradient(135deg, #45a049 0%, #33833b 100%);
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 5px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 14px;
        transition: all 0.3s ease;
      }

      .start-sitin-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(69, 160, 73, 0.4);
      }

      /* Sit-in Modal Styles */
      #sitInModal .modal-content {
        background: linear-gradient(
          135deg,
          rgba(40, 44, 52, 0.95) 0%,
          rgba(25, 29, 37, 0.95) 100%
        );
        color: white;
        padding: 30px;
        border-radius: 15px;
        max-width: 500px;
        width: 90%;
      }

      #sitInModal .student-info {
        background: rgba(255, 255, 255, 0.1);
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        text-align: center;
      }

      #sitInModal .student-info h3 {
        color: white;
        margin: 0;
        font-size: 1.2em;
      }

      #sitInModal .form-group {
        margin-bottom: 20px;
      }

      #sitInModal .form-group label {
        display: block;
        color: white;
        margin-bottom: 8px;
        font-weight: 500;
      }

      #sitInModal select {
        width: 100%;
        padding: 12px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        color: white;
        font-size: 16px;
        transition: all 0.3s ease;
      }

      #sitInModal select:focus {
        outline: none;
        border-color: #45a049;
        box-shadow: 0 0 0 2px rgba(69, 160, 73, 0.2);
      }

      #sitInModal select option {
        background: #2c3038;
        color: white;
      }

      #sitInModal button[type="submit"] {
        width: 100%;
        padding: 12px;
        background: linear-gradient(135deg, #45a049 0%, #33833b 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
      }

      #sitInModal button[type="submit"]:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(69, 160, 73, 0.4);
      }

      /* Session Card Styles */
      .session-card {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        padding: 20px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
      }

      .session-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
      }

      .session-card .student-info {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 15px;
      }

      .session-card .student-info img {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        object-fit: cover;
      }

      .session-card .student-info h3 {
        margin: 0;
        color: white;
        font-size: 1.1em;
      }

      .session-card .student-info p {
        margin: 5px 0 0;
        color: rgba(255, 255, 255, 0.7);
        font-size: 0.9em;
      }

      .session-card .session-details {
        margin-bottom: 15px;
      }

      .session-card .session-details p {
        margin: 8px 0;
        color: white;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .session-card .session-details i {
        color: #45a049;
      }

      .end-session-btn {
        width: 100%;
        padding: 10px;
        background: #dd0c0c;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: all 0.3s ease;
      }

      .end-session-btn:hover {
        background: #ff4444;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(221, 12, 12, 0.4);
      }

      /* Add these new styles */
      .active-sessions-card {
        height: calc(100vh - 140px);
        display: flex;
        flex-direction: column;
        margin-top: 10px;
      }

      .active-sessions-card .filters-container {
        margin-bottom: 15px;
        padding: 15px;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.05);
      }

      .active-sessions-card .active-sessions-grid {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        align-content: start;
      }

      .active-sessions-card .session-card {
        height: fit-content;
      }

      /* Update student info styles for end session dialog */
      .student-info-end {
        display: flex;
        align-items: center;
        gap: 15px;
        background: rgba(255, 255, 255, 0.1);
        padding: 15px;
        border-radius: 10px;
        margin: 20px 0;
      }

      .student-info-end img {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        object-fit: cover;
      }

      .student-info-end .student-details {
        flex: 1;
      }

      .student-info-end h4 {
        margin: 0;
        color: white;
        font-size: 1.1em;
      }

      .student-info-end p {
        margin: 5px 0 0;
        color: rgba(255, 255, 255, 0.7);
        font-size: 0.9em;
      }

      .confirmation-message {
        color: white;
        text-align: center;
        margin: 20px 0;
      }

      /* Compact Modal Styles */
      .compact-modal {
        max-width: 400px !important;
        padding: 20px !important;
        background: linear-gradient(
          135deg,
          rgba(40, 44, 52, 0.98) 0%,
          rgba(25, 29, 37, 0.98) 100%
        ) !important;
      }

      .compact-modal .modal-header {
        margin-bottom: 15px;
        text-align: center;
      }

      .compact-modal .modal-header h2 {
        font-size: 1.5em;
        margin: 0;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
      }

      .compact-modal .student-info {
        background: rgba(255, 255, 255, 0.1);
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 15px;
        text-align: center;
      }

      .compact-modal .student-info h3 {
        margin: 0;
        color: white;
        font-size: 1.1em;
      }

      .compact-modal .form-group-compact {
        margin-bottom: 15px;
      }

      .compact-modal select {
        width: 100%;
        padding: 10px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 6px;
        color: white;
        font-size: 14px;
        transition: all 0.3s ease;
        cursor: pointer;
      }

      .compact-modal select:focus {
        outline: none;
        border-color: #45a049;
        box-shadow: 0 0 0 2px rgba(69, 160, 73, 0.2);
      }

      .compact-modal select option {
        background: #2c3038;
        color: white;
        padding: 8px;
      }

      .compact-modal .submit-btn {
        width: 100%;
        padding: 12px;
        background: linear-gradient(135deg, #45a049 0%, #33833b 100%);
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: all 0.3s ease;
      }

      .compact-modal .submit-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(69, 160, 73, 0.4);
      }

      .compact-modal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        font-size: 20px;
        opacity: 0.8;
      }

      .compact-modal .close:hover {
        opacity: 1;
        color: #ff4444;
      }

      /* Add these new styles */
      .records-card {
        height: calc(100vh - 140px);
        display: flex;
        flex-direction: column;
      }

      .records-card .filters-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        padding: 15px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
        margin-bottom: 15px;
      }

      .records-grid {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        align-content: start;
      }

      .record-card {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        padding: 20px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
      }

      .record-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
      }

      .status-badge,
      .session-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.9em;
        font-weight: 500;
      }

      .status-badge.approved {
        background: #45a049;
        color: white;
      }

      .status-badge.ended {
        background: #666;
        color: white;
      }

      .session-badge.on_going {
        background: #4a90e2;
        color: white;
      }

      .session-badge.ended {
        background: #666;
        color: white;
      }

      .no-records {
        text-align: center;
        padding: 40px;
        color: rgba(255, 255, 255, 0.7);
        grid-column: 1 / -1;
      }

      .no-records i {
        font-size: 48px;
        margin-bottom: 15px;
        display: block;
      }

      .no-records p {
        font-size: 16px;
        margin: 0;
      }

      /* Statistics Styles */
      .statistics-container {
        display: flex;
        flex-direction: column;
        gap: 20px;
        padding: 20px;
      }

      .stats-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
      }

      .stat-card {
        background: rgba(255, 255, 255, 0.1);
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        transition: transform 0.3s ease;
      }

      .stat-card:hover {
        transform: translateY(-5px);
      }

      .stat-card i {
        font-size: 2em;
        color: #45a049;
        margin-bottom: 10px;
      }

      .stat-card h3 {
        margin: 10px 0;
        font-size: 1.2em;
        color: #fff;
      }

      .stat-card p {
        font-size: 2em;
        font-weight: bold;
        color: #45a049;
        margin: 10px 0;
      }

      .charts-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }

      .chart-card {
        background: rgba(255, 255, 255, 0.1);
        padding: 20px;
        border-radius: 10px;
        min-height: 300px;
      }

      .chart-card h3 {
        text-align: center;
        margin-bottom: 20px;
        color: #fff;
      }

      .chart-card canvas {
        width: 100% !important;
        height: auto !important;
        max-height: 400px;
      }

      /* Feedback Styles */
      .feedbacks-container {
        display: flex;
        flex-direction: column;
        gap: 20px;
        padding: 20px;
      }

      .feedback-card {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        padding: 20px;
        backdrop-filter: blur(10px);
      }

      .feedback-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 15px;
      }

      .student-info {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .student-info img {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        object-fit: cover;
      }

      .student-details h3 {
        margin: 0;
        color: #fff;
      }

      .student-details p {
        margin: 5px 0;
        color: #ccc;
      }

      .session-info {
        text-align: right;
        color: #ccc;
      }

      .feedback-content {
        background: rgba(0, 0, 0, 0.2);
        padding: 15px;
        border-radius: 8px;
        color: #fff;
      }

      .no-feedbacks {
        text-align: center;
        padding: 40px;
        color: #ccc;
      }

      .no-feedbacks i {
        font-size: 3em;
        margin-bottom: 10px;
        color: #45a049;
      }

      /* Report Controls Styles */
      .report-controls {
        background: rgba(255, 255, 255, 0.1);
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
      }

      .filter-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .filter-group label {
        color: #fff;
        font-weight: 500;
      }

      .generate-report-btn {
        background: #45a049;
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 8px;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        margin-top: 24px;
      }

      .generate-report-btn:hover {
        background: #33833b;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(69, 160, 73, 0.4);
      }

      /* Feedback Card Styles */
      .feedback-card {
        background: rgba(255, 255, 255, 0.1);
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 15px;
        transition: transform 0.3s ease;
      }

      .feedback-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }

      .feedback-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 15px;
      }

      .student-info {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .student-profile-pic {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid #45a049;
      }

      .student-details h3 {
        margin: 0;
        color: #fff;
        font-size: 1.2em;
      }

      .student-details p {
        margin: 5px 0;
        color: #ccc;
      }

      .session-info {
        text-align: right;
      }

      .session-info p {
        margin: 5px 0;
        color: #ccc;
      }

      .session-info i {
        width: 20px;
        color: #45a049;
      }

      .feedback-content {
        background: rgba(0, 0, 0, 0.2);
        padding: 15px;
        border-radius: 8px;
        margin-top: 10px;
      }

      .feedback-content p {
        margin: 0;
        color: #fff;
        line-height: 1.5;
      }

      .feedback-date {
        display: block;
        margin-top: 10px;
        color: #ccc;
        font-size: 0.9em;
      }

      .feedback-date i {
        color: #45a049;
        margin-right: 5px;
      }

      .no-feedbacks {
        text-align: center;
        padding: 40px;
        color: #ccc;
      }

      .no-feedbacks i {
        font-size: 48px;
        margin-bottom: 15px;
        display: block;
        color: #45a049;
      }

      /* Custom Scrollbar */
      .custom-scrollbar::-webkit-scrollbar {
        width: 8px;
      }

      .custom-scrollbar::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 4px;
      }

      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.3);
        border-radius: 4px;
        transition: background 0.3s ease;
      }

      .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.5);
      }

      /* Add these styles for wider report columns */
      .report-table {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
      }

      .report-table th,
      .report-table td {
        padding: 12px;
        text-align: left;
        border: 1px solid #ddd;
        min-width: 150px; /* Minimum width for columns */
        max-width: 300px; /* Maximum width for columns */
        white-space: normal; /* Allow text wrapping */
        word-wrap: break-word; /* Break long words if needed */
      }

      .report-table th {
        background-color: #4CAF50;
        color: white;
        font-weight: bold;
      }

      .report-table tr:nth-child(even) {
        background-color: rgba(255, 255, 255, 0.05);
      }

      .report-table tr:hover {
        background-color: rgba(255, 255, 255, 0.1);
      }

      /* Active Sessions Statistics Styles */
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
      }

      .stat-box {
        background: rgba(255, 255, 255, 0.1);
        padding: 20px;
        border-radius: 10px;
      }

      .stat-box h4 {
        margin: 0 0 15px 0;
        color: #45a049;
        font-size: 18px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .stat-content {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .stat-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 5px;
      }

      .stat-item span {
        color: #fff;
      }

      .stat-item .count {
        background: #45a049;
        padding: 4px 8px;
        border-radius: 15px;
        font-size: 14px;
        font-weight: bold;
      }

      /* Active and Ended Sessions Grid Styles */
      .active-sessions-grid,
      .ended-sessions-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 15px;
        padding: 15px;
        max-height: 500px;
        overflow-y: auto;
      }

      .session-card {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        padding: 15px;
        transition: transform 0.3s ease;
      }

      .session-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }

      .session-card.ended {
        border-left: 4px solid #45a049;
      }

      .session-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 10px;
      }

      .student-info {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .student-info img {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
      }

      .session-details {
        margin-top: 10px;
      }

      .session-details p {
        margin: 5px 0;
        color: #ccc;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .session-details i {
        color: #45a049;
        width: 16px;
      }

      .end-session-btn {
        background: #dd0c0c;
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 5px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 14px;
        transition: all 0.3s ease;
      }

      .end-session-btn:hover {
        background: #ff4444;
        transform: translateY(-2px);
      }

      .duration-badge {
        background: rgba(69, 160, 73, 0.2);
        color: #45a049;
        padding: 4px 8px;
        border-radius: 15px;
        font-size: 12px;
        display: inline-flex;
        align-items: center;
        gap: 5px;
      }

      .active-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
      }

      .stats-card {
        background: rgba(255, 255, 255, 0.1);
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .stats-card h3 {
        margin: 0 0 15px 0;
        display: flex;
        align-items: center;
        gap: 10px;
        color: #fff;
        font-size: 1.1em;
      }

      .stats-card h3 i {
        color: #45a049;
      }

      .stat-number {
        font-size: 2em;
        font-weight: bold;
        color: #45a049;
        margin: 0;
      }

      .stat-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .stat-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 5px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .stat-label {
        color: #fff;
      }

      .stat-value {
        background: #45a049;
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.9em;
      }

      .section-subtitle {
        margin: 30px 0 20px;
        color: #fff;
        font-size: 1.2em;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .section-subtitle i {
        color: #45a049;
      }

      .session-count {
        padding: 4px 8px;
        border-radius: 12px;
        font-weight: bold;
      }

      .session-count.positive {
        background-color: #45a049;
        color: white;
      }

      .session-count.zero {
        background-color: #dd0c0c;
        color: white;
      }

      .action-buttons {
        display: flex;
        gap: 8px;
        justify-content: center;
      }

      .action-buttons button {
        padding: 6px 12px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .action-buttons .edit-btn {
        background-color: #4a90e2;
        color: white;
      }

      .action-buttons .delete-btn {
        background-color: #dd0c0c;
        color: white;
      }

      .action-buttons button:hover {
        transform: translateY(-2px);
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      }

      .student-table td {
        vertical-align: middle;
      }

      /* Add these styles */
      .student-profile {
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .student-profile-pic {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid #45a049;
        transition: all 0.3s ease;
      }

      .student-profile-pic:hover {
        transform: scale(1.1);
        box-shadow: 0 0 10px rgba(69, 160, 73, 0.5);
      }

      .student-table td {
        padding: 12px;
        vertical-align: middle;
      }

      .student-table th {
        padding: 12px;
        text-align: center;
      }

      .student-table tbody tr {
        transition: all 0.3s ease;
      }

      .student-table tbody tr:hover {
        background: rgba(255, 255, 255, 0.1);
      }

      .resources-container {
        margin-top: 20px;
      }

      .resources-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
      }

      .resource-card {
        background: var(--card-bg);
        border-radius: 12px;
        padding: 20px;
        border: 1px solid var(--border-color);
        transition: all 0.3s ease;
      }

      .resource-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
      }

      .resource-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }

      .resource-header h3 {
        margin: 0;
        font-size: 1.2rem;
        color: var(--text-primary);
      }

      .resource-status {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 500;
      }

      .resource-status.enabled {
        background: var(--accent-green);
        color: white;
      }

      .resource-status.disabled {
        background: var(--text-muted);
        color: white;
      }

      .resource-body {
        margin-bottom: 15px;
      }

      .resource-body p {
        color: var(--text-secondary);
        margin: 0 0 10px 0;
      }

      .resource-meta {
        display: flex;
        gap: 15px;
        font-size: 0.9rem;
        color: var(--text-muted);
      }

      .resource-meta span {
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .resource-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .action-btn {
        padding: 8px 12px;
        border: none;
        border-radius: 8px;
        font-size: 0.9rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 5px;
        transition: all 0.3s ease;
      }

      .action-btn.download {
        background: var(--accent-blue);
        color: white;
      }

      .action-btn.edit {
        background: var(--accent-green);
        color: white;
      }

      .action-btn.toggle {
        background: var(--text-muted);
        color: white;
      }

      .action-btn.delete {
        background: var(--accent-red);
        color: white;
      }

      .action-btn:hover {
        transform: translateY(-2px);
        filter: brightness(1.1);
      }

      .no-resources {
        text-align: center;
        padding: 40px;
        color: var(--text-muted);
        grid-column: 1 / -1;
      }

      .no-resources i {
        font-size: 48px;
        margin-bottom: 15px;
      }

      /* Form Styles */
      #resourceForm .form-group {
        margin-bottom: 20px;
      }

      #resourceForm label {
        display: block;
        margin-bottom: 8px;
        color: var(--text-secondary);
      }

      #resourceForm input[type="text"],
      #resourceForm input[type="url"],
      #resourceForm textarea,
      #resourceForm select {
        width: 100%;
        padding: 10px;
        background: var(--form-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        color: var(--text-primary);
      }

      #resourceForm select[multiple] {
        height: 120px;
      }

      #resourceForm small {
        display: block;
        margin-top: 5px;
        color: var(--text-muted);
      }

      /* Add these styles for purpose management */
      .purpose-actions {
        display: flex;
        gap: 10px;
      }

      .edit-btn {
        background: #3498db;
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .edit-btn:hover {
        background: #2980b9;
        transform: translateY(-2px);
      }

      .purpose-item {
        background: rgba(255, 255, 255, 0.1);
        padding: 15px;
        border-radius: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        transition: all 0.3s ease;
      }

      .purpose-item:hover {
        transform: translateX(5px);
        background: rgba(255, 255, 255, 0.15);
      }

      .purpose-info {
        flex: 1;
      }

      .purpose-info h4 {
        margin: 0;
        color: #fff;
        font-size: 1.1em;
      }

      /* Add these styles */
      .reset-all-btn {
        background: #3498db;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s ease;
      }

      .reset-all-btn:hover {
        background: #2980b9;
        transform: translateY(-2px);
      }

      .reset-btn {
        background: #3498db;
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 5px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 5px;
        transition: all 0.3s ease;
      }

      .reset-btn:hover {
        background: #2980b9;
        transform: translateY(-2px);
      }

      .student-actions {
        display: flex;
        gap: 10px;
        margin-top: 10px;
      }

      .reset-all-btn {
        background: #4a90e2;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        transition: all 0.3s ease;
      }

      .reset-all-btn:hover {
        background: #357abd;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(74, 144, 226, 0.4);
      }

      .reset-btn {
        background: #4a90e2;
        color: white;
        border: none;
        padding: 8px;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .reset-btn:hover {
        background: #357abd;
        transform: translateY(-2px);
      }
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
      let cropper = null;
      let logoutForm = null;
      let currentSessionToEnd = null;
      let currentResourceId = null;

      // Update the confirmation dialog handling
      function showConfirmDialog(
        type,
        title,
        message,
        yesText,
        noText,
        yesAction
      ) {
        const dialog = document.getElementById("confirmDialog");
        const content = dialog.querySelector(".confirm-content");

        content.innerHTML = `
          <h3>${title}</h3>
          <p>${message}</p>
          <div class="confirm-buttons">
            <button onclick="handleDialogAction('${type}', true)" class="confirm-btn confirm-yes">
              <i class="fas fa-check"></i> ${yesText}
            </button>
            <button onclick="handleDialogAction('${type}', false)" class="confirm-btn confirm-no">
              <i class="fas fa-times"></i> ${noText}
            </button>
          </div>
        `;

        dialog.dataset.dialogType = type;
        dialog.dataset.actionData = yesAction ? JSON.stringify(yesAction) : "";
        dialog.style.display = "flex";
      }

      function handleDialogAction(type, confirmed) {
        const dialog = document.getElementById("confirmDialog");
        if (confirmed) {
          const actionData = dialog.dataset.actionData
            ? JSON.parse(dialog.dataset.actionData)
            : null;
          console.log('Dialog action:', type, 'Action data:', actionData);
          
          switch (type) {
            case "logout":
              if (logoutForm) logoutForm.submit();
              break;
            case "delete_announcement":
              if (actionData) handleAnnouncementDelete(actionData);
              break;
            case "delete_lab":
              if (actionData) handleLabDelete(actionData);
              break;
            case "reset_all_sessions":
              handleResetAllSessions();
              break;
            case "reset_student_session":
              const studentId = actionData && typeof actionData === 'object' ? actionData.student_id : actionData;
              if (studentId) {
                handleResetStudentSession(studentId);
              } else {
                console.error('Invalid action data for reset:', actionData);
                showToast('Invalid student ID', 'error');
              }
              break;
          }
        }
        dialog.style.display = "none";
        dialog.dataset.dialogType = "";
        dialog.dataset.actionData = "";
      }

      function confirmLogout(event) {
        event.preventDefault();
        logoutForm = event.target;
        showConfirmDialog(
          "logout",
          "Confirm Logout",
          "Are you sure you want to logout?",
          "Yes, Logout",
          "Cancel"
        );
        return false;
      }

      function handleLogout() {
        if (logoutForm) {
          logoutForm.submit();
        }
        closeConfirmDialog();
      }

      function closeConfirmDialog() {
        document.getElementById("confirmDialog").style.display = "none";
      }

      // Close dialog when clicking outside
      document
        .getElementById("confirmDialog")
        .addEventListener("click", function (event) {
          if (event.target === this) {
            closeConfirmDialog();
          }
        });

      // Update modal behavior to close when clicking outside
      document.addEventListener("DOMContentLoaded", function () {
        // Get all modals
        const modals = document.querySelectorAll(".modal, .confirm-dialog");

        // Add click event listener to each modal
        modals.forEach((modal) => {
          modal.addEventListener("click", function (event) {
            if (event.target === this) {
              // If clicked outside modal content
              if (modal.id === "editModal") closeModal();
              else if (modal.id === "addLabModal") closeAddLabModal();
              else if (modal.id === "addAnnouncementModal")
                closeAddAnnouncementModal();
              else if (modal.id === "endSessionModal") closeEndSessionModal();
              else if (modal.id === "cropperModal") closeCropperModal();
              else if (modal.id === "confirmDialog") closeConfirmDialog();
            }
          });
        });

        // Initialize dashboard
        showSection("manageLabs", document.querySelector(".button"));
        fetchLabs();
        fetchAnnouncements();
        loadActiveSessions();
      });

      // Add styles for confirmation buttons
      const style = document.createElement("style");
      style.textContent = `
        .confirm-yes {
          background: #dd0c0c !important;
        }

        .confirm-no {
          background: #45a049 !important;
        }
      `;
      document.head.appendChild(style);

      // Show/Hide Sections
      function showSection(sectionId, button) {
        document.querySelectorAll(".content-section").forEach((section) => {
          section.style.display = "none";
          section.classList.remove("show");
        });
        const section = document.getElementById(sectionId);
        section.style.display = "block";
        setTimeout(() => section.classList.add("show"), 10);

        document
          .querySelectorAll(".button")
          .forEach((btn) => btn.classList.remove("selected"));
        button.classList.add("selected");

        // Load records when showing the records section
        if (sectionId === "sitInRecords") {
          filterRecords();
        }

        if (sectionId === "statistics") {
          fetchStatistics();
        } else if (sectionId === "feedbacks") {
          fetchFeedbacks();
        }
      }

      // Profile picture functionality
      function previewImage(input) {
        if (input.files && input.files[0]) {
          const file = input.files[0];
          const reader = new FileReader();

          reader.onload = function (e) {
            const cropperModal = document.getElementById("cropperModal");
            const cropperImage = document.getElementById("cropperImage");

            // Reset cropper if it exists
            if (cropper) {
              cropper.destroy();
              cropper = null;
            }

            cropperImage.src = e.target.result;
            cropperModal.style.display = "flex";

            // Wait for image to load before initializing cropper
            cropperImage.onload = function () {
              cropper = new Cropper(cropperImage, {
                aspectRatio: 1,
                viewMode: 1,
                dragMode: "move",
                autoCropArea: 0.8,
                restore: false,
                guides: true,
                center: true,
                highlight: false,
                cropBoxMovable: true,
                cropBoxResizable: true,
                toggleDragModeOnDblclick: false,
                ready: function () {
                  // Center the crop box when the cropper is ready
                  const containerData = cropper.getContainerData();
                  const cropBoxData = cropper.getCropBoxData();
                  const left = (containerData.width - cropBoxData.width) / 2;
                  const top = (containerData.height - cropBoxData.height) / 2;
                  cropper.setCropBoxData({ left: left, top: top });
                },
              });
            };
          };

          reader.readAsDataURL(file);
        }
      }

      function closeCropperModal() {
        const cropperModal = document.getElementById("cropperModal");
        cropperModal.style.display = "none";
        if (cropper) {
          cropper.destroy();
          cropper = null;
        }
        // Reset file inputs
        document.getElementById("profile-upload").value = "";
        document.getElementById("modal-profile-upload").value = "";
      }

      function saveCroppedImage() {
        if (!cropper) return;

        const canvas = cropper.getCroppedCanvas({
          width: 400,
          height: 400,
        });

        canvas.toBlob(
          function (blob) {
            const formData = new FormData();
            formData.append("profile_picture", blob, "profile.jpg");

            fetch('{{ url_for("staff.update_profile_picture") }}', {
              method: "POST",
              body: formData,
            })
              .then((response) => response.json())
              .then((data) => {
                if (data.success) {
                  document.querySelector(".preview-profile-image").src =
                    data.profile_picture_data;
                  document.querySelector(".profile-image").src =
                    data.profile_picture_data;
                  document.querySelector(".large-profile-image").src =
                    data.profile_picture_data;
                  closeCropperModal();
                }
              });
          },
          "image/jpeg",
          0.95
        );
      }

      // Modal functionality
      const modal = document.getElementById("editModal");
      const formGroups = document.querySelectorAll(".form-group");

      function openModal() {
        // Get current values from the page
        const currentFirstName = "{{ staff_firstname }}";
        const currentLastName = "{{ staff_lastname }}";
        const currentEmail = "{{ staff_email }}";

        // Set the form field values
        document.getElementById("firstname").value = currentFirstName;
        document.getElementById("lastname").value = currentLastName;
        document.getElementById("email").value = currentEmail;

        modal.style.display = "block";
        document.body.style.overflow = "hidden";
        animateFormGroups();
      }

      function closeModal() {
        modal.style.display = "none";
        document.body.style.overflow = "auto";
      }

      function animateFormGroups() {
        formGroups.forEach((group, index) => {
          setTimeout(() => {
            group.classList.add("show");
          }, 100 * index);
        });
      }

      // Profile dropdown
      function toggleProfileMenu(event) {
        event.preventDefault();
        const dropdown = document.querySelector(".profile-dropdown-content");
        dropdown.classList.toggle("show");
      }

      // Close dropdown when clicking outside
      window.onclick = function (event) {
        if (!event.target.matches(".profile-icon")) {
          const dropdowns = document.getElementsByClassName(
            "profile-dropdown-content"
          );
          for (let dropdown of dropdowns) {
            if (dropdown.classList.contains("show")) {
              dropdown.classList.remove("show");
            }
          }
        }
        if (event.target == modal) {
          closeModal();
        }
      };

      // Lab Management
      document
        .getElementById("addLabForm")
        .addEventListener("submit", function (event) {
          event.preventDefault();
          const labName = document.getElementById("labId").value;
          const totalComputers = parseInt(
            document.getElementById("totalComputers").value
          );

          fetch("/manage_labs", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              lab_name: labName,
              total_computers: totalComputers,
            }),
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.error) {
                showToast(data.error, "error");
              } else {
                showToast("Lab added successfully", "success");
                closeAddLabModal();
                fetchLabs();
              }
            });
        });

      function fetchLabs() {
        fetch("/manage_labs")
          .then((response) => response.json())
          .then((labs) => {
            const labList = document.getElementById("labList");
            labList.innerHTML = "";
            labs.forEach((lab) => {
              const div = document.createElement("div");
              div.className = "lab-item";
              div.innerHTML = `
                <div class="lab-info">
                  <h4>${lab.LAB_NAME}</h4>
                  <p>${lab.TOTAL_COMPUTERS} computers (${lab.AVAILABLE_COMPUTERS} available)</p>
                </div>
                <div class="lab-actions">
                  <button onclick="deleteLab('${lab.LAB_ID}')" class="delete-btn">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              `;
              labList.appendChild(div);
            });
          });
      }

      function deleteLab(labId) {
        showConfirmDialog(
          "delete_lab",
          "Delete Lab",
          "Are you sure you want to delete this lab?",
          "Yes, Delete",
          "Cancel",
          labId
        );
      }

      // Student Search with Profile Pictures
      document
        .querySelector(".search-form")
        .addEventListener("submit", function (event) {
          event.preventDefault();
          const studentId = document.getElementById("studentId").value;
          const noResults = document.getElementById("noResults");
          const searchResults = document.getElementById("searchResults");

          fetch(`/search_student/${studentId}`)
            .then((response) => response.json())
            .then((students) => {
              searchResults.innerHTML = "";
              if (students.length === 0) {
                noResults.style.display = "block";
                searchResults
                  .closest(".results-container")
                  .classList.add("empty");
              } else {
                noResults.style.display = "none";
                searchResults
                  .closest(".results-container")
                  .classList.remove("empty");
                students.forEach((student) => {
                  const tr = document.createElement("tr");
                  tr.innerHTML = `
                  <td>
                    <img src="/get_profile_picture/${student.IDNO}" 
                         alt="Profile" 
                         class="student-profile-pic"
                         onerror="this.src='/static/default_profile.png'">
                    ${student.IDNO}
                    <span class="remaining-sessions">(${student.REMAINING_SESSIONS} sessions left)</span>
                  </td>
            <td>${student.NAME}</td>
            <td>${student.COURSE}</td>
            <td>${student.YEAR}</td>
                  <td>${student.EMAIL}</td>
                  <td>
                    <button class="action-button start-sitin-btn" onclick="openSitInModal('${student.IDNO}', '${student.NAME}')">
                      <i class="fas fa-sign-in-alt"></i> Start Sit-in
                    </button>
                  </td>
                `;
                  searchResults.appendChild(tr);
                });
              }
            });
        });

      // Announcements Management
      document
        .getElementById("announcementForm")
        .addEventListener("submit", function (event) {
          event.preventDefault();
          const title = document.getElementById("title").value;
          const content = document.getElementById("content").value;

          fetch("/announcements", {
            method: "POST",
          headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ title, content }),
        })
          .then((response) => response.json())
            .then((data) => {
              if (data.error) {
                showToast(data.error, "error");
              } else {
                showToast("Announcement posted successfully", "success");
                closeAddAnnouncementModal();
                fetchAnnouncements();
              }
            });
        });

      function fetchAnnouncements() {
        fetch("/announcements")
          .then((response) => response.json())
          .then((announcements) => {
            const container = document.getElementById("announcementsList");
            container.innerHTML = "";
            announcements.forEach((announcement) => {
              const div = document.createElement("div");
              div.className = "announcement-item";

              // Check if the current staff member is the poster
              const isOwner =
                announcement.posted_by === '{{ session["IDNO"] }}';

              div.innerHTML = `
          <h3>${announcement.title}</h3>
          <p>${announcement.content}</p>
                <div class="announcement-meta">
                  <small>Posted on ${announcement.date_posted}</small>
                </div>
                ${
                  isOwner
                    ? `
          <div class="announcement-actions">
                    <button class="edit" onclick='editAnnouncement(${JSON.stringify(
                      announcement
                    ).replace(/'/g, "\\'")})'">
                      <i class="fas fa-edit"></i> Edit
                    </button>
                    <button class="delete" onclick="deleteAnnouncement(${
                      announcement.announcement_id
                    })">
                      <i class="fas fa-trash"></i> Delete
                    </button>
          </div>
                `
                    : ""
                }
              `;
              container.appendChild(div);
            });
          });
      }

      function editAnnouncement(announcement) {
        // Create a form for editing
        const form = document.createElement("form");
        form.innerHTML = `
          <div class="form-group">
            <input type="text" value="${announcement.title}" required>
          </div>
          <div class="form-group">
            <textarea required>${announcement.content}</textarea>
          </div>
          <div class="form-actions">
            <button type="submit" class="save">Save</button>
            <button type="button" class="cancel">Cancel</button>
          </div>
        `;

        // Replace the announcement content with the form
        const announcementItem = event.target.closest(".announcement-item");
        const originalContent = announcementItem.innerHTML;
        announcementItem.innerHTML = "";
        announcementItem.appendChild(form);

        form.addEventListener("submit", function (e) {
          e.preventDefault();
          const newTitle = form.querySelector("input").value;
          const newContent = form.querySelector("textarea").value;

          fetch(`/announcements/${announcement.announcement_id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ title: newTitle, content: newContent }),
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.error) {
                showToast(data.error, "error");
              } else {
                showToast("Announcement updated successfully", "success");
                fetchAnnouncements();
              }
            });
        });

        form.querySelector(".cancel").addEventListener("click", function () {
          announcementItem.innerHTML = originalContent;
        });
      }

      function deleteAnnouncement(announcementId) {
        showConfirmDialog(
          "delete_announcement",
          "Delete Announcement",
          "Are you sure you want to delete this announcement?",
          "Yes, Delete",
          "Cancel",
          announcementId
        );
      }

      function handleAnnouncementDelete(announcementId) {
        fetch(`/announcements/${announcementId}`, {
          method: "DELETE",
        })
          .then((response) => response.json())
          .then((data) => {
            closeConfirmDialog();
            if (data.error) {
              showToast(data.error, "error");
            } else {
              showToast("Announcement deleted successfully", "success");
              fetchAnnouncements();
            }
          });
      }

      // Add success/error toast notifications
      function showToast(message, type = "success") {
        const toast = document.getElementById("toast");
        const icon = toast.querySelector("i");
        const messageSpan = toast.querySelector(".toast-message");

        // Set icon based on type
        icon.className =
          type === "success"
            ? "fas fa-check-circle"
            : "fas fa-exclamation-circle";
        messageSpan.textContent = message;

        // Add appropriate class
        toast.className = `toast ${type}`;
        toast.classList.add("show");

        // Hide after 3 seconds
        setTimeout(() => {
          toast.classList.remove("show");
        }, 3000);
      }

      // Add these new functions
      function openAddLabModal() {
        const modal = document.getElementById("addLabModal");
        if (modal) {
          modal.style.display = "block";
          document.body.style.overflow = "hidden";
          animateFormGroups();
        }
      }

      function closeAddLabModal() {
        const modal = document.getElementById("addLabModal");
        modal.style.display = "none";
        document.body.style.overflow = "auto";
        document.getElementById("addLabForm").reset();
      }

      function openAddAnnouncementModal() {
        const modal = document.getElementById("addAnnouncementModal");
        if (modal) {
          modal.style.display = "block";
          document.body.style.overflow = "hidden";
          animateFormGroups();
        }
      }

      function closeAddAnnouncementModal() {
        const modal = document.getElementById("addAnnouncementModal");
        modal.style.display = "none";
        document.body.style.overflow = "auto";
        document.getElementById("announcementForm").reset();
      }

      function openEditAnnouncementModal(announcement) {
        const modal = document.getElementById("editAnnouncementModal");
        const titleInput = document.getElementById("editAnnouncementTitle");
        const contentInput = document.getElementById("editAnnouncementContent");
        const idInput = document.getElementById("editAnnouncementId");

        titleInput.value = announcement.title;
        contentInput.value = announcement.content;
        idInput.value = announcement.announcement_id;

        modal.style.display = "block";
      }

      function closeEditAnnouncementModal() {
        const modal = document.getElementById("editAnnouncementModal");
        modal.style.display = "none";
      }

      // Update the editAnnouncement function
      function editAnnouncement(announcement) {
        openEditAnnouncementModal(announcement);
      }

      // Add event listener for edit form submission
      document
        .getElementById("editAnnouncementForm")
        .addEventListener("submit", function (event) {
          event.preventDefault();
          const announcementId =
            document.getElementById("editAnnouncementId").value;
          const title = document.getElementById("editAnnouncementTitle").value;
          const content = document.getElementById(
            "editAnnouncementContent"
          ).value;

          fetch(`/announcements/${announcementId}`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ title, content }),
          })
          .then((response) => response.json())
          .then((data) => {
              if (data.error) {
                alert(data.error);
              } else {
                closeEditAnnouncementModal();
                fetchAnnouncements(); // Refresh the announcements list
              }
            });
        });

      // Close modal when clicking outside
      window.onclick = function (event) {
        const editModal = document.getElementById("editAnnouncementModal");
        if (event.target == editModal) {
          closeEditAnnouncementModal();
        }
      };

      function openSitInModal(studentId, studentName) {
        // First check if student has an ongoing session
        fetch(`/staff/sitin_records?student_id=${studentId}&session=ON_GOING`)
          .then((response) => response.json())
          .then((records) => {
            if (records && records.length > 0) {
              showToast(
                "Student already has an ongoing sit-in session",
                "error"
              );
              return;
            }

            // Check remaining sessions only if there's no ongoing session
            fetch(`/staff/check_remaining_sessions/${studentId}`)
              .then((response) => response.json())
              .then((data) => {
                if (data.error || data.remaining_sessions <= 0) {
                  showToast(
                    "Student has no remaining sit-in sessions",
                    "error"
                  );
              return;
            }

                document.getElementById("sitInStudentId").value = studentId;
                document.getElementById("sitInStudentName").textContent =
                  studentName;

                // Fetch labs and purposes for dropdowns with loading indicators
                const labSelect = document.getElementById("sitInLab");
                const purposeSelect = document.getElementById("sitInPurpose");

                labSelect.innerHTML =
                  '<option value="">Loading labs...</option>';
                purposeSelect.innerHTML =
                  '<option value="">Loading purposes...</option>';

                Promise.all([
                  fetch("/staff/laboratories").then((response) => {
                    if (!response.ok) throw new Error("Failed to fetch labs");
                    return response.json();
                  }),
                  fetch("/staff/purposes").then((response) => {
                    if (!response.ok)
                      throw new Error("Failed to fetch purposes");
                    return response.json();
                  }),
                ])
                  .then(([labs, purposes]) => {
                    labSelect.innerHTML =
                      '<option value="">Select Lab</option>';
                    purposeSelect.innerHTML =
                      '<option value="">Select Purpose</option>';

                    labs.forEach((lab) => {
                      labSelect.innerHTML += `<option value="${lab.LAB_ID}">${lab.LAB_NAME}</option>`;
                    });

                    purposes.forEach((purpose) => {
                      purposeSelect.innerHTML += `<option value="${purpose.PURPOSE_ID}">${purpose.PURPOSE_NAME}</option>`;
                    });

                    document.getElementById("sitInModal").style.display =
                      "flex";
                  })
                  .catch((error) => {
                    console.error("Error loading data:", error);
                    labSelect.innerHTML =
                      '<option value="">Error loading labs</option>';
                    purposeSelect.innerHTML =
                      '<option value="">Error loading purposes</option>';
                    showToast(error.message, "error");
                  });
              })
              .catch((error) => {
                showToast(
                  "Error checking remaining sessions: " + error.message,
                  "error"
                );
              });
          })
          .catch((error) => {
            showToast(
              "Error checking ongoing sessions: " + error.message,
              "error"
            );
          });
      }

      function closeSitInModal() {
        document.getElementById("sitInModal").style.display = "none";
        document.getElementById("sitInForm").reset();
      }

      function loadActiveSessions() {
        const labId = document.getElementById('activeFilterLab')?.value;
        const purposeId = document.getElementById('activeFilterPurpose')?.value;
        
        let url = '/staff/active_sessions';
        const params = new URLSearchParams();
        if (labId) params.append('lab_id', labId);
        if (purposeId) params.append('purpose_id', purposeId);
        if (params.toString()) url += '?' + params.toString();

        const container = document.querySelector('.active-sessions-grid');
        container.innerHTML = '<div class="loading">Loading active sessions...</div>';

        fetch(url)
            .then(response => response.json())
            .then(sessions => {
                container.innerHTML = '';
                
                if (sessions.length === 0) {
                    container.innerHTML = `
                        <div class="no-records">
                            <i class="fas fa-desktop"></i>
                            <p>No active sessions</p>
          </div>
        `;
                    updateStatistics([]); // Update stats with empty array
                    return;
                }

                sessions.forEach(session => {
                    const startTime = new Date(session.DATE);
                    const card = document.createElement('div');
                    card.className = 'session-card';
                    card.innerHTML = `
                        <div class="session-header">
                            <div class="student-info">
                                <img src="${session.PROFILE_PICTURE_URL}" 
                                     alt="Student Profile"
                                     class="student-profile"
                                     onerror="this.onerror=null; this.src='/static/images/default-profile.png';">
                                <div>
                                    <h3>${session.STUDENT_NAME}</h3>
                                    <p class="student-id">${session.STUDENT_ID}</p>
                                </div>
                            </div>
                            <button onclick="endSession(${session.RECORD_ID})" class="end-session-btn">
                                <i class="fas fa-stop-circle"></i> End Session
                            </button>
                        </div>
                        <div class="session-details">
                            <p><i class="fas fa-desktop"></i> ${session.LAB_NAME}</p>
                            <p><i class="fas fa-tasks"></i> ${session.PURPOSE_NAME}</p>
                            <p><i class="fas fa-clock"></i> Started: ${formatTime(startTime)}</p>
                            <p><i class="fas fa-hourglass-half"></i> Duration: <span id="duration-${session.RECORD_ID}">Calculating...</span></p>
                        </div>
                    `;
                    container.appendChild(card);
                    updateDuration(session.RECORD_ID, startTime);
                });

                // Update statistics
                updateStatistics(sessions);

                // Start updating durations every minute
                if (!window.durationInterval) {
                    window.durationInterval = setInterval(() => {
                        sessions.forEach(session => {
                            updateDuration(session.RECORD_ID, new Date(session.DATE));
                        });
                    }, 60000);
                }
            })
            .catch(error => {
                container.innerHTML = `
                    <div class="error">
                        <i class="fas fa-exclamation-circle"></i>
                        <p>Error loading active sessions: ${error.message}</p>
                    </div>
                `;
                updateStatistics([]); // Update stats with empty array on error
            });
      }

      function updateStatistics(sessions) {
        const statsContainer = document.querySelector('.active-stats');
        if (!statsContainer) return;

        // Calculate statistics
        const totalActive = sessions.length;
        const labStats = {};
        const purposeStats = {};

        sessions.forEach(session => {
          // Update lab statistics
          labStats[session.LAB_NAME] = (labStats[session.LAB_NAME] || 0) + 1;
          // Update purpose statistics
          purposeStats[session.PURPOSE_NAME] = (purposeStats[session.PURPOSE_NAME] || 0) + 1;
        });

        // Update the statistics display
        statsContainer.innerHTML = `
          <div class="stats-card total">
            <h3><i class="fas fa-users"></i> Total Active Sessions</h3>
            <p class="stat-number">${totalActive}</p>
          </div>
          <div class="stats-card labs">
            <h3><i class="fas fa-desktop"></i> By Laboratory</h3>
            <div class="stat-list">
              ${Object.entries(labStats).map(([lab, count]) => `
                <div class="stat-item">
                  <span class="stat-label">${lab}</span>
                  <span class="stat-value">${count}</span>
                </div>
              `).join('')}
            </div>
          </div>
          <div class="stats-card purposes">
            <h3><i class="fas fa-tasks"></i> By Purpose</h3>
            <div class="stat-list">
              ${Object.entries(purposeStats).map(([purpose, count]) => `
                <div class="stat-item">
                  <span class="stat-label">${purpose}</span>
                  <span class="stat-value">${count}</span>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }

      // Add function to load today's ended sessions
      function loadEndedSessions() {
          console.log('Loading ended sessions...');
          const today = new Date().toISOString().split('T')[0];
          console.log('Today\'s date:', today);
          
          fetch('/staff/today_ended_sessions')
              .then(response => {
                  console.log('Got response:', response.status);
                  return response.json();
              })
              .then(sessions => {
                  console.log('Received sessions:', sessions);
                  const container = document.querySelector('.ended-sessions-grid');
                  container.innerHTML = '';
                  
                  if (!sessions || sessions.length === 0) {
                      console.log('No ended sessions found');
                      container.innerHTML = `
                          <div class="no-records">
                              <i class="fas fa-history"></i>
                              <p>No ended sessions today</p>
                          </div>
                      `;
                      return;
                  }

                  console.log(`Processing ${sessions.length} ended sessions`);
                  sessions.forEach(session => {
                      console.log('Processing session:', session);
                      const card = document.createElement('div');
                      card.className = 'session-card ended';
                      card.innerHTML = `
                          <div class="session-header">
                              <div class="student-info">
                                  <img src="${session.PROFILE_PICTURE_URL}" 
                                       alt="Student Profile"
                                       class="student-profile"
                                       onerror="this.onerror=null; this.src='/static/images/default-profile.png';">
                                  <div>
                                      <h3>${session.student_name}</h3>
                                      <p class="student-id">${session.user_idno}</p>
                                  </div>
                              </div>
                              <span class="session-badge ended">Ended</span>
                          </div>
                          <div class="session-details">
                              <p><i class="fas fa-desktop"></i> ${session.lab_name}</p>
                              <p><i class="fas fa-tasks"></i> ${session.purpose_name}</p>
                              <p><i class="fas fa-clock"></i> Started: ${formatDateTime(session.date)}</p>
                              <p><i class="fas fa-clock"></i> Ended: ${formatDateTime(session.end_time)}</p>
                          </div>
                      `;
                      container.appendChild(card);
                  });
              })
              .catch(error => {
                  console.error('Error loading ended sessions:', error);
                  const container = document.querySelector('.ended-sessions-grid');
                  container.innerHTML = `
                      <div class="error">
                          <i class="fas fa-exclamation-circle"></i>
                          <p>Error loading ended sessions: ${error.message}</p>
                      </div>
                  `;
              });
      }

      // Make sure loadEndedSessions is called when needed
      document.addEventListener('DOMContentLoaded', function() {
          console.log('Page loaded, checking if we should load ended sessions');
          if (document.getElementById('activeSitins')) {
              console.log('Active sitins section found, loading ended sessions');
              loadEndedSessions();
          }
      });

      // Also call loadEndedSessions after ending a session
      function endSession(recordId) {
          if (!confirm('Are you sure you want to end this session?')) {
              return;
          }

          fetch(`/staff/end_session/${recordId}`, {
              method: 'POST'
          })
          .then(response => response.json())
          .then(data => {
              if (data.success) {
                  showToast('Session ended successfully', 'success');
                  loadActiveSessions();
                  loadEndedSessions();  // Reload ended sessions after ending one
              } else {
                  showToast(data.error || 'Failed to end session', 'error');
              }
          })
          .catch(error => {
              showToast('Error ending session: ' + error.message, 'error');
          });
      }

      // Call both functions when loading active sessions section
      function loadActiveSitins() {
          loadActiveSessions();
          loadEndedSessions();
      }

      // Add this to your initialization code
      document.addEventListener('DOMContentLoaded', function() {
        // ... existing initialization code ...
        if (document.getElementById('activeSessions')) {
          loadFilters();
          loadActiveSessions();
        }
      });

      function loadFilters() {
        // Load labs for filter
        fetch("/staff/laboratories")
          .then((response) => response.json())
          .then((labs) => {
            const labSelect = document.getElementById("filterLab");
            labs.forEach((lab) => {
              if (!labSelect.querySelector(`option[value="${lab.LAB_ID}"]`)) {
                labSelect.innerHTML += `<option value="${lab.LAB_ID}">${lab.LAB_NAME}</option>`;
              }
            });
          });

        // Load purposes for filter
        fetch("/staff/purposes")
          .then((response) => response.json())
          .then((purposes) => {
            const purposeSelect = document.getElementById("filterPurpose");
            purposes.forEach((purpose) => {
              if (
                !purposeSelect.querySelector(
                  `option[value="${purpose.PURPOSE_ID}"]`
                )
              ) {
                purposeSelect.innerHTML += `<option value="${purpose.PURPOSE_ID}">${purpose.PURPOSE_NAME}</option>`;
              }
            });
          });
      }

      function filterSessions() {
        loadActiveSessions();
      }

      function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleString();
      }

      function openEndSessionModal(
        recordId,
        studentName,
        studentId,
        labName,
        purposeName
      ) {
        currentSessionToEnd = recordId;
        const modal = document.getElementById("endSessionModal");
        const studentImg = document.getElementById("endSessionStudentImg");
        const nameElement = document.getElementById("endSessionStudentName");
        const detailsElement = document.getElementById("endSessionDetails");

        studentImg.src = `/get_profile_picture/${studentId}`;
        studentImg.onerror = () =>
          (studentImg.src = "/static/default_profile.png");
        nameElement.textContent = studentName;
        detailsElement.textContent = `${labName} - ${purposeName}`;

        modal.style.display = "flex";
      }

      function closeEndSessionModal() {
        document.getElementById("endSessionModal").style.display = "none";
        currentSessionToEnd = null;
      }

      function confirmEndSession() {
        if (!currentSessionToEnd) return;

        fetch(`/staff/end_session/${currentSessionToEnd}`, {
          method: "POST",
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.error) {
              showToast(data.error, "error");
            } else {
              showToast("Session ended successfully", "success");
              closeEndSessionModal();
              loadActiveSessions();
            }
          })
          .catch((error) => {
            showToast("Error ending session: " + error.message, "error");
          });
      }

      // Initialize active sessions when the page loads
      document.addEventListener("DOMContentLoaded", function () {
        if (
          document.getElementById("activeSessions").style.display !== "none"
        ) {
          loadActiveSessions();
        }
      });

      function startSitIn(event) {
        event.preventDefault();
        const studentId = document.getElementById("sitInStudentId").value;
        const labId = document.getElementById("sitInLab").value;
        const purposeId = document.getElementById("sitInPurpose").value;

        if (!studentId || !labId || !purposeId) {
          showToast("Please fill in all fields", "error");
          return;
        }

        fetch("/staff/start_sitin", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            student_id: studentId,
            lab_id: labId,
            purpose_id: purposeId,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.error) {
              showToast(data.error, "error");
            } else {
              showToast("Sit-in session started successfully", "success");
              closeSitInModal();
              loadActiveSessions();
            }
          })
          .catch((error) => {
            showToast(
              "Error starting sit-in session: " + error.message,
              "error"
            );
          });
      }

      // Initialize filters and data when page loads
      document.addEventListener("DOMContentLoaded", function () {
        if (
          document.getElementById("activeSessions").style.display !== "none"
        ) {
          loadActiveSessions();
        }
        loadFilters();
      });

      function loadFilters() {
        // Load labs for filters
        fetch("/staff/laboratories")
          .then((response) => response.json())
          .then((labs) => {
            const labSelects = ["filterLab", "recordFilterLab"];
            labSelects.forEach((selectId) => {
              const select = document.getElementById(selectId);
              if (select) {
                select.innerHTML = '<option value="">All Labs</option>';
                labs.forEach((lab) => {
                  select.innerHTML += `<option value="${lab.LAB_ID}">${lab.LAB_NAME}</option>`;
                });
              }
            });
          });

        // Load purposes for filters
        fetch("/staff/purposes")
          .then((response) => response.json())
          .then((purposes) => {
            const purposeSelects = ["filterPurpose", "recordFilterPurpose"];
            purposeSelects.forEach((selectId) => {
              const select = document.getElementById(selectId);
              if (select) {
                select.innerHTML = '<option value="">All Purposes</option>';
                purposes.forEach((purpose) => {
                  select.innerHTML += `<option value="${purpose.PURPOSE_ID}">${purpose.PURPOSE_NAME}</option>`;
                });
              }
            });
          });
      }

      function filterRecords() {
        const labId = document.getElementById("recordFilterLab").value;
        const purposeId = document.getElementById("recordFilterPurpose").value;
        const status = document.getElementById("recordFilterStatus").value;
        const session = document.getElementById("recordFilterSession").value;

        let url = "/staff/sitin_records";
        const params = new URLSearchParams();
        if (labId) params.append("lab_id", labId);
        if (purposeId) params.append("purpose_id", purposeId);
        if (status) params.append("status", status);
        if (session) params.append("session", session);
        if (params.toString()) url += "?" + params.toString();

        const container = document.querySelector(".records-grid");
        container.innerHTML = '<div class="loading">Loading records...</div>';

        fetch(url)
          .then((response) => response.json())
          .then((records) => {
            container.innerHTML = "";

            if (records.length === 0) {
              container.innerHTML = `
                <div class="no-records">
                  <i class="fas fa-history"></i>
                  <p>No records found</p>
                </div>
              `;
          return;
            }

            records.forEach((record) => {
              const card = document.createElement("div");
              card.className = "record-card";
              card.innerHTML = `
                <div class="student-info">
                  <img src="/get_profile_picture/${record.STUDENT_ID}" 
                       alt="Student" 
                       class="student-profile-pic"
                       onerror="this.src='/static/default_profile.png'">
                  <div>
                    <h3>${record.STUDENT_NAME}</h3>
                    <p>${record.STUDENT_ID}</p>
                  </div>
                </div>
                <div class="record-details">
                  <p><i class="fas fa-desktop"></i> ${record.LAB_NAME}</p>
                  <p><i class="fas fa-tasks"></i> ${record.PURPOSE_NAME}</p>
                  <p><i class="fas fa-clock"></i> Started: ${formatDate(
                    record.DATE
                  )}</p>
                  ${
                    record.END_TIME
                      ? `<p><i class="fas fa-clock"></i> Ended: ${formatDate(
                          record.END_TIME
                        )}</p>`
                      : ""
                  }
                  <p><i class="fas fa-info-circle"></i> Status: <span class="status-badge ${record.STATUS.toLowerCase()}">${
                record.STATUS
              }</span></p>
                  <p><i class="fas fa-spinner"></i> Session: <span class="session-badge ${record.SESSION.toLowerCase()}">${
                record.SESSION
              }</span></p>
                </div>
              `;
              container.appendChild(card);
            });
          })
          .catch((error) => {
            container.innerHTML = `
              <div class="error">
                <i class="fas fa-exclamation-circle"></i>
                <p>Error loading records: ${error.message}</p>
              </div>
            `;
            showToast("Error loading records: " + error.message, "error");
          });
      }

      function handleLabDelete(labId) {
        fetch("/manage_labs", {
          method: "DELETE",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            lab_id: labId,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.error) {
              showToast(data.error, "error");
            } else {
              showToast("Lab deleted successfully", "success");
              fetchLabs();
            }
          })
          .catch((error) => {
            showToast("Error deleting lab: " + error.message, "error");
          });
      }

      async function fetchStatistics() {
        try {
            // Destroy existing charts if they exist and are valid Chart instances
            if (window.purposeChart instanceof Chart) {
                window.purposeChart.destroy();
            }
            if (window.labChart instanceof Chart) {
                window.labChart.destroy();
            }

            const response = await fetch('/staff/statistics');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            console.log("Statistics data received:", data);  // Debug log

            // Update statistics cards
            document.getElementById('registeredStudents').textContent = data.registered_students;
            document.getElementById('currentSitins').textContent = data.current_sitins;
            document.getElementById('totalSitins').textContent = data.total_sitins;

            // Create purpose chart if there is data
            if (data.purpose_stats && data.purpose_stats.length > 0) {
                const purposeCtx = document.getElementById('purposeChart').getContext('2d');
                window.purposeChart = new Chart(purposeCtx, {
                    type: 'pie',
                    data: {
                        labels: data.purpose_stats.map(stat => stat.purpose_name),
                        datasets: [{
                            data: data.purpose_stats.map(stat => stat.count),
                            backgroundColor: generateColors(data.purpose_stats.length)
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    color: 'white'
                                }
                            }
                        }
                    }
                });
            }

            // Create lab chart if there is data
            if (data.lab_stats && data.lab_stats.length > 0) {
                const labCtx = document.getElementById('labChart').getContext('2d');
                window.labChart = new Chart(labCtx, {
                    type: 'pie',
                    data: {
                        labels: data.lab_stats.map(stat => stat.lab_name),
                        datasets: [{
                            data: data.lab_stats.map(stat => stat.count),
                            backgroundColor: generateColors(data.lab_stats.length)
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    color: 'white'
                                }
                            }
                        }
                    }
                });
            }
        } catch (error) {
            console.error('Error fetching statistics:', error);
            // Clear any partial data
            document.getElementById('registeredStudents').textContent = '0';
            document.getElementById('currentSitins').textContent = '0';
            document.getElementById('totalSitins').textContent = '0';
        }
    }

      function fetchFeedbacks() {
        const container = document.querySelector('.feedbacks-container');
        if (!container) return;

        container.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading feedbacks...</div>';

        fetch('/staff/feedbacks')
          .then(response => {
            if (!response.ok) {
              throw new Error('Failed to fetch feedbacks');
            }
            return response.json();
          })
          .then(feedbacks => {
            if (!feedbacks || feedbacks.length === 0) {
              container.innerHTML = `
                <div class="no-data">
                  <i class="fas fa-comments-slash"></i>
                  <p>No feedback records found</p>
                </div>
              `;
              return;
            }

            container.innerHTML = '';
            feedbacks.forEach(feedback => {
              const card = document.createElement('div');
              card.className = 'feedback-card';
              card.innerHTML = `
                <div class="feedback-header">
                  <div class="student-info">
                    <img class="profile-picture" src="${feedback.PROFILE_PICTURE_URL}" onerror="this.src='/static/images/default-profile.png'" alt="Student Profile">
                    <div class="student-details">
                      <h3>${feedback.student_name}</h3>
                      <p>Student ID: ${feedback.user_idno}</p>
                    </div>
                  </div>
                  <div class="session-info">
                    <p><i class="fas fa-desktop"></i> Lab: ${feedback.lab_name || 'N/A'}</p>
                    <p><i class="fas fa-tasks"></i> Purpose: ${feedback.purpose_name || 'N/A'}</p>
                    <p><i class="fas fa-calendar"></i> Session: ${formatDateTime(feedback.session_date)}</p>
                  </div>
                </div>
                <div class="feedback-content">
                  <p>${feedback.feedback_text || 'No feedback provided'}</p>
                  <small class="feedback-date">
                    <i class="fas fa-clock"></i> Submitted: ${formatDateTime(feedback.date_submitted)}
                  </small>
                </div>
              `;
              container.appendChild(card);
            });
          })
          .catch(error => {
            console.error('Error:', error);
            container.innerHTML = `
              <div class="error-message">
                <i class="fas fa-exclamation-circle"></i>
                <p>Error loading feedbacks: ${error.message}</p>
              </div>
            `;
          });
      }

      function generateColors(count) {
        const colors = [];
        for (let i = 0; i < count; i++) {
          const hue = (i * 360) / count;
          colors.push(`hsla(${hue}, 70%, 60%, 0.8)`);
        }
        return colors;
      }

      // Initialize year filter
      function initializeYearFilter() {
        const yearFilter = document.getElementById('yearFilter');
        if (!yearFilter) return;

        const currentYear = new Date().getFullYear();
        for (let i = 0; i < 5; i++) {
          const year = currentYear - i;
          const option = document.createElement('option');
          option.value = year;
          option.textContent = year;
          yearFilter.appendChild(option);
        }
      }

      // Load feedbacks
      function loadFeedbacks() {
        const container = document.querySelector('.feedbacks-container');
        if (!container) return;

        container.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading feedbacks...</div>';

        fetch('/staff/feedbacks')
          .then(response => {
            if (!response.ok) {
              throw new Error('Failed to fetch feedbacks');
            }
            return response.json();
          })
          .then(feedbacks => {
            if (!feedbacks || feedbacks.length === 0) {
              container.innerHTML = `
                <div class="no-data">
                  <i class="fas fa-comments-slash"></i>
                  <p>No feedback records found</p>
                </div>
              `;
              return;
            }

            container.innerHTML = '';
            feedbacks.forEach(feedback => {
              const card = document.createElement('div');
              card.className = 'feedback-card';
              card.innerHTML = `
                <div class="feedback-header">
                  <div class="student-info">
                    <img class="profile-picture" src="${feedback.PROFILE_PICTURE_URL}" onerror="this.src='/static/images/default-profile.png'" alt="Student Profile">
                    <div class="student-details">
                      <h3>${feedback.student_name}</h3>
                      <p>Student ID: ${feedback.user_idno}</p>
                    </div>
                  </div>
                  <div class="session-info">
                    <p><i class="fas fa-desktop"></i> Lab: ${feedback.lab_name || 'N/A'}</p>
                    <p><i class="fas fa-tasks"></i> Purpose: ${feedback.purpose_name || 'N/A'}</p>
                    <p><i class="fas fa-calendar"></i> Session: ${formatDateTime(feedback.session_date)}</p>
                  </div>
                </div>
                <div class="feedback-content">
                  <p>${feedback.feedback_text || 'No feedback provided'}</p>
                  <small class="feedback-date">
                    <i class="fas fa-clock"></i> Submitted: ${formatDateTime(feedback.date_submitted)}
                  </small>
                </div>
              `;
              container.appendChild(card);
            });
          })
          .catch(error => {
            console.error('Error:', error);
            container.innerHTML = `
              <div class="error-message">
                <i class="fas fa-exclamation-circle"></i>
                <p>Error loading feedbacks: ${error.message}</p>
              </div>
            `;
          });
      }

      // Format date and time
      function formatDateTime(dateString) {
        if (!dateString) return 'N/A';
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return 'Invalid Date';
        return date.toLocaleString('en-US', {
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      }

      // Generate reports
      function generateReport() {
        const section = document.querySelector('.content-section[style*="display: block"]');
        if (!section) return;

        const sectionId = section.id;
        let reportType, format, filters = {};

        // Get filters based on current section
        if (sectionId === 'statistics') {
            reportType = 'statistics';
            format = document.getElementById('statisticsReportFormat').value;
        } else if (sectionId === 'feedbacks') {
            reportType = 'feedback';
            format = document.getElementById('feedbackReportFormat').value;
        } else if (sectionId === 'sitInRecords') {
            reportType = 'sit_ins';
            format = document.getElementById('sitInReportFormat').value;
            // Get filter values
            filters = {
                lab_id: document.getElementById('recordFilterLab')?.value,
                purpose_id: document.getElementById('recordFilterPurpose')?.value,
                status: document.getElementById('recordFilterStatus')?.value,
                session: document.getElementById('recordFilterSession')?.value
            };
        }

        const queryParams = new URLSearchParams({
            type: reportType,
            format: format,
            ...filters
        });

        window.location.href = `/staff/generate_reports?${queryParams}`;
    }

      function generateHistoryReport() {
        const format = document.getElementById('historyReportFormat').value;
        const labId = document.getElementById('recordFilterLab').value;
        const purposeId = document.getElementById('recordFilterPurpose').value;
        const status = document.getElementById('recordFilterStatus').value;
        const session = document.getElementById('recordFilterSession').value;

        const url = `/staff/generate_reports?${new URLSearchParams({
          format: format,
          lab_id: labId || '',
          purpose_id: purposeId || '',
          status: status || '',
          session: session || '',
          type: 'history'
        })}`;

        window.location.href = url;
      }

      function generateFeedbackReport() {
        const format = document.getElementById('feedbackReportFormat').value;

        const url = `/staff/generate_reports?${new URLSearchParams({
          format: format,
          type: 'feedback'
        })}`;

        window.location.href = url;
      }

      // Initialize everything when the document is loaded
      document.addEventListener('DOMContentLoaded', function() {
        initializeYearFilter();
        showSection('statistics', document.querySelector('.button'));
        loadFilters();
        loadActiveSessions();
        loadSitInHistory();
        loadFeedbacks();
        fetchStatistics();
        loadAllStudents();
      });

      function loadStatistics() {
        const labFilter = document.getElementById('statFilterLab').value;
        const purposeFilter = document.getElementById('statFilterPurpose').value;
        
        const container = document.querySelector('.statistics-container');
        container.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading statistics...</div>';

        fetch('/staff/statistics?' + new URLSearchParams({
          lab_id: labFilter,
          purpose_id: purposeFilter
        }))
        .then(response => {
          if (!response.ok) throw new Error('Failed to fetch statistics');
          return response.json();
        })
        .then(data => {
          if (!data) {
            container.innerHTML = '<div class="no-data">No statistics available</div>';
            return;
          }

          let html = '<div class="stats-grid">';
          // Add your statistics display logic here
          html += '</div>';
          container.innerHTML = html;
        })
        .catch(error => {
          console.error('Error:', error);
          container.innerHTML = `<div class="error-message">Error loading statistics: ${error.message}</div>`;
        });
      }

      // Add these utility functions for date/time formatting
      function formatTime(date) {
          if (!(date instanceof Date)) {
              date = new Date(date);
          }
          return date.toLocaleTimeString('en-US', {
              hour: '2-digit',
              minute: '2-digit',
              hour12: true
          });
      }

      function formatDateTime(dateStr) {
          if (!dateStr) return 'N/A';
          const date = new Date(dateStr);
          return date.toLocaleString('en-US', {
              year: 'numeric',
              month: 'short',
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit',
              hour12: true
          });
      }

      function updateDuration(recordId, startTime) {
          const durationElement = document.getElementById(`duration-${recordId}`);
          if (!durationElement) return;

          const now = new Date();
          const start = new Date(startTime);
          const diff = Math.floor((now - start) / 1000); // difference in seconds
          const hours = Math.floor(diff / 3600);
          const minutes = Math.floor((diff % 3600) / 60);

          if (hours > 0) {
              durationElement.textContent = `${hours}h ${minutes}m`;
          } else {
              durationElement.textContent = `${minutes}m`;
          }
      }

      function loadAllStudents() {
        const container = document.querySelector('.students-container');
        if (!container) {
          console.error('Students container not found');
          return;
        }

        container.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading students...</div>';

        fetch('/staff/all_students')
          .then(response => {
            if (!response.ok) throw new Error('Failed to fetch students');
            return response.json();
          })
          .then(students => {
            if (!students || students.length === 0) {
              container.innerHTML = '<div class="no-data"><i class="fas fa-users-slash"></i><p>No students found</p></div>';
              return;
            }

            const table = document.createElement('table');
            table.className = 'student-table';
            
            const rows = students.map(student => {
              const idno = student.IDNO;
              return `
                <tr data-idno="${idno}">
                  <td>
                    <div class="student-profile">
                      <img src="${student.PROFILE_PICTURE_URL}" 
                           alt="Profile" 
                           class="student-profile-pic"
                           onerror="this.src='/static/default_profile.png'">
                    </div>
                  </td>
                  <td>${idno}</td>
                  <td>${student.FIRSTNAME} ${student.LASTNAME}</td>
                  <td>${student.COURSE || 'N/A'}</td>
                  <td>${student.YEAR || 'N/A'}</td>
                  <td>${student.EMAIL || 'N/A'}</td>
                  <td>
                    <span class="session-count ${parseInt(student.REMAINING_SESSIONS) > 0 ? 'positive' : 'zero'}">
                      ${student.REMAINING_SESSIONS || '0'}
                    </span>
                  </td>
                  <td class="action-buttons">
                    <button type="button"
                            onclick="confirmResetStudentSession('${idno}', '${student.FIRSTNAME} ${student.LASTNAME}', '${student.COURSE}')"
                            class="reset-btn"
                            title="Reset Sessions"
                            data-idno="${idno}">
                      <i class="fas fa-redo"></i>
                    </button>
                  </td>
                </tr>
              `;
            });

            table.innerHTML = `
              <thead>
                <tr>
                  <th>Profile</th>
                  <th>ID</th>
                  <th>Name</th>
                  <th>Course</th>
                  <th>Year</th>
                  <th>Email</th>
                  <th>Remaining Sessions</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                ${rows.join('')}
              </tbody>
            `;

            container.innerHTML = '';
            container.appendChild(table);
          })
          .catch(error => {
            console.error('Error loading students:', error);
            container.innerHTML = `
              <div class="error-message">
                <i class="fas fa-exclamation-circle"></i>
                <p>Error loading students: ${error.message}</p>
              </div>
            `;
          });
      }

      function generateStudentReport() {
        const format = document.getElementById('studentReportFormat').value;
        const url = `/staff/generate_reports?${new URLSearchParams({
          format: format,
          type: 'students'
        })}`;

        window.location.href = url;
      }

      // Function to load all students
      function loadStudents() {
        const container = document.querySelector('.students-container');
        if (!container) return;

        container.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading students...</div>';

        fetch('/staff/all_students')
          .then(response => response.json())
          .then(students => {
            if (!students || students.length === 0) {
              container.innerHTML = '<div class="no-data"><i class="fas fa-users-slash"></i><p>No students found</p></div>';
              return;
            }

            const table = document.createElement('table');
            table.className = 'student-table';
            
            const rows = students.map(student => {
              const idno = student.IDNO;
              return `
                <tr data-idno="${idno}">
                  <td>
                    <div class="student-profile">
                      <img src="${student.PROFILE_PICTURE_URL}" 
                           alt="Profile" 
                           class="student-profile-pic"
                           onerror="this.src='/static/default_profile.png'">
                    </div>
                  </td>
                  <td>${idno}</td>
                  <td>${student.FIRSTNAME} ${student.LASTNAME}</td>
                  <td>${student.COURSE || 'N/A'}</td>
                  <td>${student.YEAR || 'N/A'}</td>
                  <td>${student.EMAIL || 'N/A'}</td>
                  <td>
                    <span class="session-count ${parseInt(student.REMAINING_SESSIONS) > 0 ? 'positive' : 'zero'}">
                      ${student.REMAINING_SESSIONS || '0'}
                    </span>
                  </td>
                  <td class="action-buttons">
                    <button type="button"
                            onclick="confirmResetStudentSession('${idno}', '${student.FIRSTNAME} ${student.LASTNAME}', '${student.COURSE}')"
                            class="reset-btn"
                            title="Reset Sessions"
                            data-idno="${idno}">
                      <i class="fas fa-redo"></i>
                    </button>
                  </td>
                </tr>
              `;
            });

            table.innerHTML = `
              <thead>
                <tr>
                  <th>Profile</th>
                  <th>ID</th>
                  <th>Name</th>
                  <th>Course</th>
                  <th>Year</th>
                  <th>Email</th>
                  <th>Remaining Sessions</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                ${rows.join('')}
              </tbody>
            `;

            container.innerHTML = '';
            container.appendChild(table);
          })
          .catch(error => {
            console.error('Error loading students:', error);
            container.innerHTML = `
              <div class="error-message">
                <i class="fas fa-exclamation-circle"></i>
                <p>Error loading students: ${error.message}</p>
              </div>
            `;
          });
      }

      // Update the showSection function to load students when the students section is shown
      function showSection(sectionId, button) {
        document.querySelectorAll('.content-section').forEach(section => {
          section.style.display = 'none';
          section.classList.remove('show');
        });
        const section = document.getElementById(sectionId);
        section.style.display = 'block';
        setTimeout(() => section.classList.add('show'), 10);

        document.querySelectorAll('.button').forEach(btn => btn.classList.remove('selected'));
        button.classList.add('selected');

        // Load data based on section
        if (sectionId === 'sitInRecords') {
          filterRecords();
        } else if (sectionId === 'statistics') {
          fetchStatistics();
        } else if (sectionId === 'feedbacks') {
          fetchFeedbacks();
        } else if (sectionId === 'students') {
          loadAllStudents();  // Call loadAllStudents instead of loadStudents
        }
      }

      // Add these new functions for editing and deleting students
      function editStudent(studentId) {
        // TODO: Implement edit student functionality
        console.log('Edit student:', studentId);
        alert('Edit student functionality coming soon!');
      }

      function deleteStudent(studentId) {
        if (!confirm(`Are you sure you want to delete student ${studentId}?`)) {
          return;
        }
        
        // TODO: Implement delete student functionality
        console.log('Delete student:', studentId);
        alert('Delete student functionality coming soon!');
      }

      function loadResources() {
        fetch('/api/resources')
          .then(response => response.json())
          .then(resources => {
            const container = document.getElementById('resourcesList');
            container.innerHTML = '';
            
            if (resources.length === 0) {
              container.innerHTML = `
                <div class="no-data">
                  <i class="fas fa-book"></i>
                  <p>No resources available</p>
                </div>
              `;
              return;
            }
            
            resources.forEach(resource => {
              const card = document.createElement('div');
              card.className = 'resource-card';
              card.innerHTML = `
                <div class="resource-info">
                  <h4>${resource.title}</h4>
                  <p>${resource.description}</p>
                  <p><strong>Type:</strong> ${resource.resource_type}</p>
                  <p><strong>Courses:</strong> ${resource.courses.join(', ')}</p>
                  <p><strong>Created by:</strong> ${resource.creator_name || 'Unknown'}</p>
                  <p><strong>Date:</strong> ${new Date(resource.created_at).toLocaleString()}</p>
                </div>
                <div class="resource-actions">
                  ${resource.resource_type === 'FILE' ? 
                    `<button onclick="downloadResource(${resource.resource_id})" class="action-button primary">
                      <i class="fas fa-download"></i> Download
                    </button>` : ''}
                  <button onclick="editResource(${resource.resource_id})" class="action-button edit">
                    <i class="fas fa-edit"></i> Edit
                  </button>
                  <button onclick="deleteResource(${resource.resource_id})" class="action-button danger">
                    <i class="fas fa-trash"></i> Delete
                  </button>
                </div>
              `;
              container.appendChild(card);
            });
          })
          .catch(error => {
            console.error('Error loading resources:', error);
            showToast('Error loading resources', 'error');
          });
      }

      function openAddResourceModal() {
        document.getElementById('addResourceModal').style.display = 'block';
        loadCoursesForSelect();
        // Reset and hide all resource type inputs
        document.getElementById('fileInput').style.display = 'none';
        document.getElementById('linkInput').style.display = 'none';
        document.getElementById('textInput').style.display = 'none';
      }

      function closeAddResourceModal() {
        document.getElementById('addResourceModal').style.display = 'none';
        document.getElementById('addResourceForm').reset();
        // Reset and hide all resource type inputs
        document.getElementById('fileInput').style.display = 'none';
        document.getElementById('linkInput').style.display = 'none';
        document.getElementById('textInput').style.display = 'none';
      }

      function loadCoursesForSelect() {
        fetch('/api/courses')
          .then(response => response.json())
          .then(courses => {
            const addSelect = document.getElementById('courses');
            const editSelect = document.getElementById('editCourses');
            
            if (addSelect) {
              addSelect.innerHTML = '';
              courses.forEach(course => {
                const option = document.createElement('option');
                option.value = course;
                option.textContent = course;
                addSelect.appendChild(option);
              });
            }
            
            if (editSelect) {
              editSelect.innerHTML = '';
              courses.forEach(course => {
                const option = document.createElement('option');
                option.value = course;
                option.textContent = course;
                editSelect.appendChild(option);
              });
            }
          })
          .catch(error => {
            console.error('Error loading courses:', error);
            showToast('Error loading courses', 'error');
          });
      }

      // Handle resource form submission
      document.getElementById('addResourceForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData();
        formData.append('title', document.getElementById('resourceTitle').value);
        formData.append('description', document.getElementById('resourceDescription').value);
        formData.append('resource_type', document.getElementById('resourceType').value);
        
        const courses = Array.from(document.getElementById('courseSelect').selectedOptions)
          .map(option => option.value);
        courses.forEach(course => formData.append('courses[]', course));
        
        const resourceType = document.getElementById('resourceType').value;
        if (resourceType === 'FILE') {
          const fileInput = document.getElementById('resourceFile');
          if (fileInput.files.length > 0) {
            formData.append('file', fileInput.files[0]);
          }
        } else if (resourceType === 'LINK') {
          formData.append('content_url', document.getElementById('resourceUrl').value);
        } else if (resourceType === 'TEXT') {
          formData.append('content_text', document.getElementById('resourceText').value);
        }
        
        fetch('/api/resources', {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(result => {
          if (result.error) {
            showToast(result.error, 'error');
          } else {
            showToast('Resource added successfully', 'success');
            closeAddResourceModal();
            loadResources();
          }
        })
        .catch(error => {
          console.error('Error adding resource:', error);
          showToast('Error adding resource', 'error');
        });
      });

      // Handle resource type change
      document.getElementById('resourceType').addEventListener('change', function(e) {
        const type = e.target.value;
        document.getElementById('fileInput').style.display = type === 'FILE' ? 'block' : 'none';
        document.getElementById('urlInput').style.display = type === 'LINK' ? 'block' : 'none';
        document.getElementById('textInput').style.display = type === 'TEXT' ? 'block' : 'none';
      });

      // Download resource
      function downloadResource(resourceId) {
        window.location.href = `/api/resources/download/${resourceId}`;
      }

      // Edit resource
      function editResource(resourceId) {
        // Load courses first
        loadCoursesForSelect();
        
        fetch(`/api/resources/${resourceId}`)
          .then(response => response.json())
          .then(resource => {
            // Set form values
            document.getElementById('editResourceId').value = resourceId;
            document.getElementById('editTitle').value = resource.title;
            document.getElementById('editDescription').value = resource.description;
            document.getElementById('editResourceType').value = resource.resource_type;
            
            // Set content based on resource type
            if (resource.resource_type === 'LINK') {
              document.getElementById('editContentUrl').value = resource.content_url;
            } else if (resource.resource_type === 'TEXT') {
              document.getElementById('editContentText').value = resource.content_text;
            }
            
            // Show appropriate input fields
            toggleEditResourceInputs();
            
            // Set selected courses after a short delay to ensure courses are loaded
            setTimeout(() => {
              const courseSelect = document.getElementById('editCourses');
              if (courseSelect && resource.courses) {
                Array.from(courseSelect.options).forEach(option => {
                  option.selected = resource.courses.includes(option.value);
                });
              }
            }, 500);
            
            // Show the modal
            document.getElementById('editResourceModal').style.display = 'block';
          })
          .catch(error => {
            console.error('Error loading resource:', error);
            showToast('Error loading resource details', 'error');
          });
      }

      // Update resource
      function updateResource(resourceId) {
        const formData = new FormData();
        formData.append('title', document.getElementById('resourceTitle').value);
        formData.append('description', document.getElementById('resourceDescription').value);
        formData.append('resource_type', document.getElementById('resourceType').value);
        
        const courses = Array.from(document.getElementById('courseSelect').selectedOptions)
          .map(option => option.value);
        courses.forEach(course => formData.append('courses[]', course));
        
        const resourceType = document.getElementById('resourceType').value;
        if (resourceType === 'FILE') {
          const fileInput = document.getElementById('resourceFile');
          if (fileInput.files.length > 0) {
            formData.append('file', fileInput.files[0]);
          }
        } else if (resourceType === 'LINK') {
          formData.append('content_url', document.getElementById('resourceUrl').value);
        } else if (resourceType === 'TEXT') {
          formData.append('content_text', document.getElementById('resourceText').value);
        }
        
        fetch(`/api/resources/${resourceId}`, {
          method: 'PUT',
          body: formData
        })
        .then(response => response.json())
        .then(result => {
          if (result.error) {
            showToast(result.error, 'error');
          } else {
            showToast('Resource updated successfully', 'success');
            closeAddResourceModal();
            loadResources();
            // Reset form submission to add
            document.getElementById('addResourceForm').onsubmit = function(e) {
              e.preventDefault();
              addResource();
            };
          }
        })
        .catch(error => {
          console.error('Error updating resource:', error);
          showToast('Error updating resource', 'error');
        });
      }

      // Delete resource
      function deleteResource(resourceId) {
        if (confirm('Are you sure you want to delete this resource?')) {
          fetch(`/api/resources/${resourceId}`, {
            method: 'DELETE'
          })
          .then(response => response.json())
          .then(result => {
            if (result.error) {
              showToast(result.error, 'error');
            } else {
              showToast('Resource deleted successfully', 'success');
              loadResources();
            }
          })
          .catch(error => {
            console.error('Error deleting resource:', error);
            showToast('Error deleting resource', 'error');
          });
        }
      }

      // Load resources when section is shown
      document.querySelector('button[onclick="showSection(\'resources\', this)"]')
        .addEventListener('click', loadResources);

      // Add these new functions for purpose management
      function openEditPurposeModal(purposeId, purposeName) {
        document.getElementById('editPurposeId').value = purposeId;
        document.getElementById('editPurposeName').value = purposeName;
        document.getElementById('editPurposeModal').style.display = 'block';
      }

      function closeEditPurposeModal() {
        document.getElementById('editPurposeModal').style.display = 'none';
        document.getElementById('editPurposeForm').reset();
      }

      // Update the fetchPurposes function to include edit button
      function fetchPurposes() {
        fetch('/admin/purposes')
          .then(response => response.json())
          .then(purposes => {
            const purposeList = document.getElementById('purposeList');
            if (!purposeList) return;
            
            purposeList.innerHTML = '';
            purposes.forEach(purpose => {
              const div = document.createElement('div');
              div.className = 'purpose-item';
              div.innerHTML = `
                <div class="purpose-info">
                  <h4>${purpose.PURPOSE_NAME}</h4>
                </div>
                <div class="purpose-actions">
                  <button onclick="openEditPurposeModal(${purpose.PURPOSE_ID}, '${purpose.PURPOSE_NAME.replace(/'/g, "\\'")}')" class="edit-btn">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button onclick="deletePurpose(${purpose.PURPOSE_ID})" class="delete-btn">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              `;
              purposeList.appendChild(div);
            });
          })
          .catch(error => {
            console.error('Error fetching purposes:', error);
            showToast('Failed to load purposes', 'error');
          });
      }

      // Add event listener for edit form submission
      document.getElementById('editPurposeForm').addEventListener('submit', function(event) {
        event.preventDefault();
        const purposeId = document.getElementById('editPurposeId').value;
        const purposeName = document.getElementById('editPurposeName').value;

        fetch(`/admin/purposes/${purposeId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ purposeName: purposeName })
        })
        .then(response => response.json())
        .then(data => {
          if (data.error) {
            showToast(data.error, 'error');
          } else {
            showToast('Purpose updated successfully', 'success');
            closeEditPurposeModal();
            fetchPurposes();
          }
        })
        .catch(error => {
          console.error('Error updating purpose:', error);
          showToast('Failed to update purpose', 'error');
        });
      });

      // Add these new functions for session management
      function confirmResetAllSessions() {
        showConfirmDialog(
          'reset_all',
          'Reset All Student Sessions',
          'Are you sure you want to reset sessions for all students? This will set BSIT/BSCS students to 30 sessions and others to 15 sessions.',
          'Yes, Reset All',
          'Cancel'
        );
      }

      function confirmResetStudentSession(idno, studentName, course) {
        console.log('Confirming reset for student:', { idno, studentName, course });
        
        if (!idno || idno === 'undefined') {
          showToast('Invalid student ID', 'error');
          return;
        }

        const sessionLimit = (course === 'BSIT' || course === 'BSCS') ? 30 : 15;
        
        showConfirmDialog(
          'reset_student_session',
          'Reset Student Sessions',
          `Are you sure you want to reset sessions for ${studentName} to ${sessionLimit}?`,
          'Yes, Reset',
          'Cancel',
          { student_id: idno }  // Pass as an object
        );
      }

      function handleResetAllSessions() {
        fetch('/staff/reset_all_sessions', {
          method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            showToast('All sessions have been reset successfully', 'success');
            loadStudents();
          } else {
            showToast(data.error || 'Failed to reset sessions', 'error');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          showToast('Failed to reset sessions', 'error');
        });
      }

      function handleResetStudentSession(idno) {
        console.log('Starting reset for IDNO:', idno);
        
        if (!idno || idno === 'undefined') {
          showToast('Invalid student ID', 'error');
          return;
        }

        const url = `/staff/reset_student_session/${encodeURIComponent(idno.trim())}`;
        console.log('Making reset request to:', url);

        fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        })
        .then(response => {
          console.log('Reset response status:', response.status);
          return response.json().then(data => ({
              ok: response.ok,
              data: data
          }));
        })
        .then(({ ok, data }) => {
            console.log('Reset response data:', data);
            if (ok && data.success) {
                showToast(data.message || 'Sessions reset successfully', 'success');
                loadStudents(); // Reload the student list
            } else {
                throw new Error(data.error || 'Failed to reset sessions');
            }
        })
        .catch(error => {
            console.error('Reset request failed:', error);
            showToast(error.message || 'Failed to reset student sessions', 'error');
        });
      }

      // Update the handleConfirmedDelete function to include reset actions
      function handleConfirmedDelete(action, itemId) {
        switch(action) {
          case 'delete_lab':
            handleLabDelete(itemId);
            break;
          case 'delete_announcement':
            handleAnnouncementDelete(itemId);
            break;
          case 'delete_purpose':
            handlePurposeDelete(itemId);
            break;
          case 'reset_student':
          case 'reset_all':
            handleConfirmedReset(action, itemId);
            break;
        }
        closeConfirmDialog();
      }

      // Update the loadStudents function to include reset button
      function loadStudents() {
        const container = document.querySelector('.students-container');
        if (!container) return;

        container.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading students...</div>';

        fetch('/staff/all_students')
          .then(response => response.json())
          .then(students => {
            if (!students || students.length === 0) {
              container.innerHTML = '<div class="no-data"><i class="fas fa-users-slash"></i><p>No students found</p></div>';
              return;
            }

            const table = document.createElement('table');
            table.className = 'student-table';
            
            const rows = students.map(student => {
              const idno = student.IDNO;
              return `
                <tr data-idno="${idno}">
                  <td>
                    <div class="student-profile">
                      <img src="${student.PROFILE_PICTURE_URL}" 
                           alt="Profile" 
                           class="student-profile-pic"
                           onerror="this.src='/static/default_profile.png'">
                    </div>
                  </td>
                  <td>${idno}</td>
                  <td>${student.FIRSTNAME} ${student.LASTNAME}</td>
                  <td>${student.COURSE || 'N/A'}</td>
                  <td>${student.YEAR || 'N/A'}</td>
                  <td>${student.EMAIL || 'N/A'}</td>
                  <td>
                    <span class="session-count ${parseInt(student.REMAINING_SESSIONS) > 0 ? 'positive' : 'zero'}">
                      ${student.REMAINING_SESSIONS || '0'}
                    </span>
                  </td>
                  <td class="action-buttons">
                    <button type="button"
                            onclick="confirmResetStudentSession('${idno}', '${student.FIRSTNAME} ${student.LASTNAME}', '${student.COURSE}')"
                            class="reset-btn"
                            title="Reset Sessions"
                            data-idno="${idno}">
                      <i class="fas fa-redo"></i>
                    </button>
                  </td>
                </tr>
              `;
            });

            table.innerHTML = `
              <thead>
                <tr>
                  <th>Profile</th>
                  <th>ID</th>
                  <th>Name</th>
                  <th>Course</th>
                  <th>Year</th>
                  <th>Email</th>
                  <th>Remaining Sessions</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                ${rows.join('')}
              </tbody>
            `;

            container.innerHTML = '';
            container.appendChild(table);
          })
          .catch(error => {
            console.error('Error loading students:', error);
            container.innerHTML = `
              <div class="error-message">
                <i class="fas fa-exclamation-circle"></i>
                <p>Error loading students: ${error.message}</p>
              </div>
            `;
          });
      }

      function handleConfirmedReset(action, studentId) {
        if (action === 'reset_student') {
          fetch(`/staff/reset_student_session/${studentId}`, {
            method: 'POST'
          })
          .then(response => response.json())
          .then(data => {
            closeConfirmDialog();
            if (data.error) {
              showToast(data.error, 'error');
            } else {
              showToast(data.message, 'success');
              // Refresh the student list to show updated session counts
              fetchAllStudents();
            }
          })
          .catch(error => {
            closeConfirmDialog();
            showToast('Failed to reset student sessions', 'error');
          });
        } else if (action === 'reset_all') {
          fetch('/staff/reset_all_sessions', {
            method: 'POST'
          })
          .then(response => response.json())
          .then(data => {
            closeConfirmDialog();
            if (data.error) {
              showToast(data.error, 'error');
            } else {
              showToast(data.message, 'success');
              // Refresh the student list to show updated session counts
              fetchAllStudents();
            }
          })
          .catch(error => {
            closeConfirmDialog();
            showToast('Failed to reset all sessions', 'error');
          });
        }
      }

      // Function to confirm and reset all student sessions
      function confirmResetAllSessions() {
        showConfirmDialog(
          'reset_all_sessions',
          'Reset All Sessions',
          'Are you sure you want to reset sessions for all students? This will set BSIT and BSCS students to 30 sessions and other courses to 15 sessions.',
          'Yes, Reset All',
          'Cancel'
        );
      }

      // Function to confirm and reset individual student session
      function confirmResetStudentSession(studentId, studentName, course) {
        console.log('Confirming reset for:', { studentId, studentName, course });
        
        if (!studentId || studentId === 'undefined') {
          console.error('Invalid student ID in confirmation');
          showToast('Invalid student ID', 'error');
          return;
        }

        showConfirmDialog(
          'reset_student_session',
          'Reset Student Sessions',
          `Are you sure you want to reset the sessions for ${studentName}? This will set their sessions to ${course === 'BSIT' || course === 'BSCS' ? '30' : '15'}.`,
          'Yes, Reset',
          'Cancel',
          studentId
        );
      }

      // Update the handleConfirmAction function to include reset actions
      function handleConfirmAction(action, id) {
        switch (action) {
          case 'reset_all_sessions':
            resetAllSessions();
            break;
          case 'reset_student_session':
            resetStudentSession(id);
            break;
          // ... existing cases ...
        }
        closeConfirmDialog();
      }

      // Function to reset all student sessions
      function resetAllSessions() {
        fetch('/staff/reset_all_sessions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            showToast('All student sessions have been reset successfully', 'success');
            loadStudents(); // Reload the student list
          } else {
            showToast(data.error || 'Failed to reset sessions', 'error');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          showToast('An error occurred while resetting sessions', 'error');
        });
      }

      // Function to reset individual student session
      function resetStudentSession(studentId) {
        fetch(`/staff/reset_student_session/${studentId}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            showToast('Student sessions have been reset successfully', 'success');
            loadStudents(); // Reload the student list
          } else {
            showToast(data.error || 'Failed to reset sessions', 'error');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          showToast('An error occurred while resetting sessions', 'error');
        });
      }

      // Load lab schedule
      function loadLabSchedule() {
        fetch('/api/schedule')
          .then(response => response.json())
          .then(schedule => {
            const container = document.getElementById('scheduleList');
            container.innerHTML = '';
            
            if (schedule.length === 0) {
              container.innerHTML = `
                <div class="no-data">
                  <i class="fas fa-calendar-times"></i>
                  <p>No schedule available</p>
                </div>
              `;
              return;
            }
            
            schedule.forEach(item => {
              const card = document.createElement('div');
              card.className = 'schedule-item';
              card.innerHTML = `
                <div class="schedule-info">
                  <h4>${item.lab_name}</h4>
                  <p><strong>Day:</strong> ${item.day}</p>
                  <p><strong>Time:</strong> ${item.start_time} - ${item.end_time}</p>
                  <p><strong>Subject:</strong> ${item.subject}</p>
                  <p><strong>Instructor:</strong> ${item.instructor}</p>
                </div>
                <div class="schedule-actions">
                  <button onclick="editSchedule(${item.schedule_id})" class="action-button">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button onclick="deleteSchedule(${item.schedule_id})" class="action-button danger">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              `;
              container.appendChild(card);
            });
          })
          .catch(error => {
            console.error('Error loading schedule:', error);
            showToast('Error loading schedule', 'error');
          });
      }

      // Load top participants
      function loadTopParticipants() {
        fetch('/api/rewards/top_participants')
          .then(response => response.json())
          .then(participants => {
            const container = document.getElementById('topParticipantsList');
            container.innerHTML = '';
            
            if (participants.length === 0) {
              container.innerHTML = `
                <div class="no-data">
                  <i class="fas fa-trophy"></i>
                  <p>No participants yet</p>
                </div>
              `;
              return;
            }
            
            participants.forEach((participant, index) => {
              const card = document.createElement('div');
              card.className = 'participant-card';
              card.innerHTML = `
                <div class="rank">${index + 1}</div>
                <div class="participant-info">
                  <h4>${participant.name}</h4>
                  <p><strong>Course:</strong> ${participant.course}</p>
                  <p><strong>Points:</strong> ${participant.total_points}</p>
                  <p><strong>Rewards:</strong> ${participant.total_rewards}</p>
                </div>
              `;
              container.appendChild(card);
            });
          })
          .catch(error => {
            console.error('Error loading top participants:', error);
            showToast('Error loading top participants', 'error');
          });
      }

      // Add schedule
      document.getElementById('addScheduleForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const data = {
          lab_id: document.getElementById('labSelect').value,
          day: document.getElementById('daySelect').value,
          start_time: document.getElementById('startTime').value,
          end_time: document.getElementById('endTime').value,
          subject: document.getElementById('subject').value,
          instructor: document.getElementById('instructor').value
        };
        
        fetch('/api/schedule', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
          if (result.error) {
            showToast(result.error, 'error');
          } else {
            showToast('Schedule added successfully', 'success');
            closeAddScheduleModal();
            loadLabSchedule();
          }
        })
        .catch(error => {
          console.error('Error adding schedule:', error);
          showToast('Error adding schedule', 'error');
        });
      });

      // Add reward
      document.getElementById('addRewardForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const data = {
          student_id: document.getElementById('studentSelect').value,
          reward_type: document.getElementById('rewardType').value,
          points: document.getElementById('points').value,
          description: document.getElementById('description').value
        };
        
        fetch('/api/rewards/add', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
          if (result.error) {
            showToast(result.error, 'error');
          } else {
            showToast('Reward added successfully', 'success');
            closeAddRewardModal();
            loadTopParticipants();
          }
        })
        .catch(error => {
          console.error('Error adding reward:', error);
          showToast('Error adding reward', 'error');
        });
      });

      // Load data when sections are shown
      document.querySelector('button[onclick="showSection(\'labSchedule\', this)"]')
        .addEventListener('click', loadLabSchedule);
      document.querySelector('button[onclick="showSection(\'rewards\', this)"]')
        .addEventListener('click', loadTopParticipants);

      // Modal handling functions
      function showAddScheduleModal() {
        document.getElementById('addScheduleModal').style.display = 'block';
        loadLabsForSelect();
      }

      function closeAddScheduleModal() {
        document.getElementById('addScheduleModal').style.display = 'none';
        document.getElementById('addScheduleForm').reset();
      }

      function showAddRewardModal() {
        document.getElementById('addRewardModal').style.display = 'block';
        loadStudentsForSelect();
      }

      function closeAddRewardModal() {
        document.getElementById('addRewardModal').style.display = 'none';
        document.getElementById('addRewardForm').reset();
      }

      // Load labs for schedule form
      function loadLabsForSelect() {
        fetch('/api/laboratories')
          .then(response => response.json())
          .then(labs => {
            const select = document.getElementById('labSelect');
            select.innerHTML = '';
            labs.forEach(lab => {
              const option = document.createElement('option');
              option.value = lab.LAB_ID;
              option.textContent = lab.LAB_NAME;
              select.appendChild(option);
            });
          })
          .catch(error => {
            console.error('Error loading labs:', error);
            showToast('Error loading laboratories', 'error');
          });
      }

      // Load students for reward form
      function loadStudentsForSelect() {
        fetch('/api/all_students')
          .then(response => response.json())
          .then(students => {
            const select = document.getElementById('studentSelect');
            select.innerHTML = '';
            students.forEach(student => {
              const option = document.createElement('option');
              option.value = student.IDNO;
              option.textContent = `${student.FIRSTNAME} ${student.LASTNAME} (${student.COURSE})`;
              select.appendChild(option);
            });
          })
          .catch(error => {
            console.error('Error loading students:', error);
            showToast('Error loading students', 'error');
          });
      }

      // Edit schedule
      function editSchedule(scheduleId) {
        fetch(`/api/schedule/${scheduleId}`)
          .then(response => response.json())
          .then(schedule => {
            document.getElementById('labSelect').value = schedule.lab_id;
            document.getElementById('daySelect').value = schedule.day;
            document.getElementById('startTime').value = schedule.start_time;
            document.getElementById('endTime').value = schedule.end_time;
            document.getElementById('subject').value = schedule.subject;
            document.getElementById('instructor').value = schedule.instructor;
            
            showAddScheduleModal();
            // Change form submission to update instead of add
            document.getElementById('addScheduleForm').onsubmit = function(e) {
              e.preventDefault();
              updateSchedule(scheduleId);
            };
          })
          .catch(error => {
            console.error('Error loading schedule:', error);
            showToast('Error loading schedule details', 'error');
          });
      }

      // Update schedule
      function updateSchedule(scheduleId) {
        const data = {
          lab_id: document.getElementById('labSelect').value,
          day: document.getElementById('daySelect').value,
          start_time: document.getElementById('startTime').value,
          end_time: document.getElementById('endTime').value,
          subject: document.getElementById('subject').value,
          instructor: document.getElementById('instructor').value
        };
        
        fetch(`/api/schedule/${scheduleId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
          if (result.error) {
            showToast(result.error, 'error');
          } else {
            showToast('Schedule updated successfully', 'success');
            closeAddScheduleModal();
            loadLabSchedule();
            // Reset form submission to add
            document.getElementById('addScheduleForm').onsubmit = function(e) {
              e.preventDefault();
              addSchedule();
            };
          }
        })
        .catch(error => {
          console.error('Error updating schedule:', error);
          showToast('Error updating schedule', 'error');
        });
      }

      // Delete schedule
      function deleteSchedule(scheduleId) {
        if (confirm('Are you sure you want to delete this schedule?')) {
          fetch(`/api/schedule/${scheduleId}`, {
            method: 'DELETE'
          })
          .then(response => response.json())
          .then(result => {
            if (result.error) {
              showToast(result.error, 'error');
            } else {
              showToast('Schedule deleted successfully', 'success');
              loadLabSchedule();
            }
          })
          .catch(error => {
            console.error('Error deleting schedule:', error);
            showToast('Error deleting schedule', 'error');
          });
        }
      }

      // Add schedule
      function addSchedule() {
        const data = {
          lab_id: document.getElementById('labSelect').value,
          day: document.getElementById('daySelect').value,
          start_time: document.getElementById('startTime').value,
          end_time: document.getElementById('endTime').value,
          subject: document.getElementById('subject').value,
          instructor: document.getElementById('instructor').value
        };
        
        fetch('/api/schedule', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
          if (result.error) {
            showToast(result.error, 'error');
          } else {
            showToast('Schedule added successfully', 'success');
            closeAddScheduleModal();
            loadLabSchedule();
          }
        })
        .catch(error => {
          console.error('Error adding schedule:', error);
          showToast('Error adding schedule', 'error');
        });
      }

      // Initialize form submissions
      document.getElementById('addScheduleForm').onsubmit = function(e) {
        e.preventDefault();
        addSchedule();
      };

      // Close modals when clicking outside
      window.onclick = function(event) {
        if (event.target.className === 'modal') {
          event.target.style.display = 'none';
        }
      };

      function editResource(resourceId) {
        fetch(`/api/resources/${resourceId}`)
          .then(response => response.json())
          .then(resource => {
            // Set form values
            document.getElementById('editResourceId').value = resourceId;
            document.getElementById('editTitle').value = resource.title;
            document.getElementById('editDescription').value = resource.description;
            document.getElementById('editResourceType').value = resource.resource_type;
            
            // Set content based on resource type
            if (resource.resource_type === 'LINK') {
              document.getElementById('editContentUrl').value = resource.content_url;
            } else if (resource.resource_type === 'TEXT') {
              document.getElementById('editContentText').value = resource.content_text;
            }
            
            // Set selected courses
            const courseSelect = document.getElementById('editCourses');
            Array.from(courseSelect.options).forEach(option => {
              option.selected = resource.courses.includes(option.value);
            });
            
            // Show appropriate input fields
            toggleEditResourceInputs();
            
            // Show the modal
            document.getElementById('editResourceModal').style.display = 'block';
          })
          .catch(error => {
            console.error('Error loading resource:', error);
            showToast('Error loading resource details', 'error');
          });
      }

      function closeEditResourceModal() {
        document.getElementById('editResourceModal').style.display = 'none';
        document.getElementById('editResourceForm').reset();
      }

      function toggleEditResourceInputs() {
        const type = document.getElementById('editResourceType').value;
        console.log('Edit resource type changed to:', type); // Debug log
        
        // Hide all inputs first
        document.getElementById('editFileInput').style.display = 'none';
        document.getElementById('editLinkInput').style.display = 'none';
        document.getElementById('editTextInput').style.display = 'none';
        
        // Show the appropriate input
        if (type === 'FILE') {
          document.getElementById('editFileInput').style.display = 'block';
        } else if (type === 'LINK') {
          document.getElementById('editLinkInput').style.display = 'block';
        } else if (type === 'TEXT') {
          document.getElementById('editTextInput').style.display = 'block';
        }
      }

      function updateResource(event) {
        event.preventDefault();
        const resourceId = document.getElementById('editResourceId').value;
        
        const formData = new FormData();
        formData.append('title', document.getElementById('editTitle').value);
        formData.append('description', document.getElementById('editDescription').value);
        formData.append('resource_type', document.getElementById('editResourceType').value);
        
        const courses = Array.from(document.getElementById('editCourses').selectedOptions)
          .map(option => option.value);
        courses.forEach(course => formData.append('courses[]', course));
        
        const resourceType = document.getElementById('editResourceType').value;
        if (resourceType === 'FILE') {
          const fileInput = document.getElementById('editFile');
          if (fileInput && fileInput.files.length > 0) {
            formData.append('file', fileInput.files[0]);
          }
        } else if (resourceType === 'LINK') {
          const contentUrl = document.getElementById('editContentUrl');
          if (contentUrl) {
            formData.append('content_url', contentUrl.value);
          }
        } else if (resourceType === 'TEXT') {
          const contentText = document.getElementById('editContentText');
          if (contentText) {
            formData.append('content_text', contentText.value);
          }
        }
        
        fetch(`/api/resources/${resourceId}`, {
          method: 'PUT',
          body: formData
        })
        .then(response => response.json())
        .then(result => {
          if (result.error) {
            showToast(result.error, 'error');
          } else {
            showToast('Resource updated successfully', 'success');
            closeEditResourceModal();
            loadResources();
          }
        })
        .catch(error => {
          console.error('Error updating resource:', error);
          showToast('Error updating resource', 'error');
        });
      }

      // Add event listeners for resource type changes
      document.addEventListener('DOMContentLoaded', function() {
        const resourceTypeSelect = document.getElementById('resourceType');
        const editResourceTypeSelect = document.getElementById('editResourceType');
        
        if (resourceTypeSelect) {
          resourceTypeSelect.addEventListener('change', toggleResourceInputs);
        }
        
        if (editResourceTypeSelect) {
          editResourceTypeSelect.addEventListener('change', toggleEditResourceInputs);
        }
      });

      function toggleResourceInputs() {
        const type = document.getElementById('resourceType').value;
        console.log('Resource type changed to:', type); // Debug log
        
        // Hide all inputs first
        const fileInput = document.getElementById('fileInput');
        const linkInput = document.getElementById('linkInput');
        const textInput = document.getElementById('textInput');
        
        if (fileInput) fileInput.style.display = 'none';
        if (linkInput) linkInput.style.display = 'none';
        if (textInput) textInput.style.display = 'none';
        
        // Show the appropriate input
        if (type === 'FILE' && fileInput) {
          fileInput.style.display = 'block';
        } else if (type === 'LINK' && linkInput) {
          linkInput.style.display = 'block';
        } else if (type === 'TEXT' && textInput) {
          textInput.style.display = 'block';
        }
      }

      function toggleEditResourceInputs() {
        const type = document.getElementById('editResourceType').value;
        console.log('Edit resource type changed to:', type); // Debug log
        
        // Hide all inputs first
        const fileInput = document.getElementById('editFileInput');
        const linkInput = document.getElementById('editLinkInput');
        const textInput = document.getElementById('editTextInput');
        
        if (fileInput) fileInput.style.display = 'none';
        if (linkInput) linkInput.style.display = 'none';
        if (textInput) textInput.style.display = 'none';
        
        // Show the appropriate input
        if (type === 'FILE' && fileInput) {
          fileInput.style.display = 'block';
        } else if (type === 'LINK' && linkInput) {
          linkInput.style.display = 'block';
        } else if (type === 'TEXT' && textInput) {
          textInput.style.display = 'block';
        }
      }

      function loadCoursesForSelect() {
        fetch('/api/courses')
          .then(response => response.json())
          .then(courses => {
            const addSelect = document.getElementById('courses');
            const editSelect = document.getElementById('editCourses');
            
            if (addSelect) {
              addSelect.innerHTML = '';
              courses.forEach(course => {
                const option = document.createElement('option');
                option.value = course;
                option.textContent = course;
                addSelect.appendChild(option);
              });
            }
            
            if (editSelect) {
              editSelect.innerHTML = '';
              courses.forEach(course => {
                const option = document.createElement('option');
                option.value = course;
                option.textContent = course;
                editSelect.appendChild(option);
              });
            }
          })
          .catch(error => {
            console.error('Error loading courses:', error);
            showToast('Error loading courses', 'error');
          });
      }

      function openAddResourceModal() {
        document.getElementById('addResourceModal').style.display = 'block';
        loadCoursesForSelect();
        // Reset and hide all resource type inputs
        document.getElementById('fileInput').style.display = 'none';
        document.getElementById('linkInput').style.display = 'none';
        document.getElementById('textInput').style.display = 'none';
      }

      function closeAddResourceModal() {
        document.getElementById('addResourceModal').style.display = 'none';
        document.getElementById('addResourceForm').reset();
        // Reset and hide all resource type inputs
        document.getElementById('fileInput').style.display = 'none';
        document.getElementById('linkInput').style.display = 'none';
        document.getElementById('textInput').style.display = 'none';
      }

      function editResource(resourceId) {
        // Load courses first
        loadCoursesForSelect();
        
        fetch(`/api/resources/${resourceId}`)
          .then(response => response.json())
          .then(resource => {
            // Set form values
            document.getElementById('editResourceId').value = resourceId;
            document.getElementById('editTitle').value = resource.title;
            document.getElementById('editDescription').value = resource.description;
            document.getElementById('editResourceType').value = resource.resource_type;
            
            // Set content based on resource type
            if (resource.resource_type === 'LINK') {
              document.getElementById('editContentUrl').value = resource.content_url;
            } else if (resource.resource_type === 'TEXT') {
              document.getElementById('editContentText').value = resource.content_text;
            }
            
            // Show appropriate input fields
            toggleEditResourceInputs();
            
            // Set selected courses after a short delay to ensure courses are loaded
            setTimeout(() => {
              const courseSelect = document.getElementById('editCourses');
              if (courseSelect && resource.courses) {
                Array.from(courseSelect.options).forEach(option => {
                  option.selected = resource.courses.includes(option.value);
                });
              }
            }, 500);
            
            // Show the modal
            document.getElementById('editResourceModal').style.display = 'block';
          })
          .catch(error => {
            console.error('Error loading resource:', error);
            showToast('Error loading resource details', 'error');
          });
      }

      // Add event listeners for resource type changes
      document.addEventListener('DOMContentLoaded', function() {
        const resourceTypeSelect = document.getElementById('resourceType');
        const editResourceTypeSelect = document.getElementById('editResourceType');
        
        if (resourceTypeSelect) {
          resourceTypeSelect.addEventListener('change', toggleResourceInputs);
        }
        
        if (editResourceTypeSelect) {
          editResourceTypeSelect.addEventListener('change', toggleEditResourceInputs);
        }
      });

      // Add this function to handle resource submission
      function submitResource(event) {
        event.preventDefault();
        
        // Get all form values
        const title = document.getElementById('title').value;
        const description = document.getElementById('description').value;
        const resourceType = document.getElementById('resourceType').value;
        const courses = Array.from(document.getElementById('courses').selectedOptions)
          .map(option => option.value);
        
        // Validate required fields
        if (!title || !description || !resourceType || courses.length === 0) {
          showToast('Please fill in all required fields', 'error');
          return;
        }
        
        const formData = new FormData();
        formData.append('title', title);
        formData.append('description', description);
        formData.append('resource_type', resourceType);
        
        // Add courses
        courses.forEach(course => formData.append('courses[]', course));
        
        // Add content based on resource type
        if (resourceType === 'FILE') {
          const fileInput = document.getElementById('file');
          if (fileInput && fileInput.files.length > 0) {
            formData.append('file', fileInput.files[0]);
          } else {
            showToast('Please select a file', 'error');
            return;
          }
        } else if (resourceType === 'LINK') {
          const contentUrl = document.getElementById('contentUrl');
          if (contentUrl && contentUrl.value) {
            formData.append('content_url', contentUrl.value);
          } else {
            showToast('Please enter a URL', 'error');
            return;
          }
        } else if (resourceType === 'TEXT') {
          const contentText = document.getElementById('contentText');
          if (contentText && contentText.value) {
            formData.append('content_text', contentText.value);
          } else {
            showToast('Please enter content', 'error');
            return;
          }
        }
        
        // Send the request
        fetch('/api/resources', {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(result => {
          if (result.error) {
            showToast(result.error, 'error');
          } else {
            showToast('Resource added successfully', 'success');
            closeAddResourceModal();
            loadResources();
          }
        })
        .catch(error => {
          console.error('Error adding resource:', error);
          showToast('Error adding resource', 'error');
        });
      }

      // Update the form submission handler
      document.addEventListener('DOMContentLoaded', function() {
        const addResourceForm = document.getElementById('addResourceForm');
        const editResourceForm = document.getElementById('editResourceForm');
        const resourceTypeSelect = document.getElementById('resourceType');
        const editResourceTypeSelect = document.getElementById('editResourceType');
        
        if (addResourceForm) {
          addResourceForm.onsubmit = submitResource;
        }
        
        if (editResourceForm) {
          editResourceForm.onsubmit = submitEditResource;
        }
        
        if (resourceTypeSelect) {
          resourceTypeSelect.addEventListener('change', toggleResourceInputs);
        }
        
        if (editResourceTypeSelect) {
          editResourceTypeSelect.addEventListener('change', toggleEditResourceInputs);
        }
      }); // Close the DOMContentLoaded event listener

      // Handle resource type change
      document.addEventListener('DOMContentLoaded', function() {
        const resourceTypeSelect = document.getElementById('resourceType');
        if (resourceTypeSelect) {
          resourceTypeSelect.addEventListener('change', function(e) {
            const type = e.target.value;
            const fileInput = document.getElementById('fileInput');
            const urlInput = document.getElementById('urlInput');
            const textInput = document.getElementById('textInput');
            
            if (fileInput) fileInput.style.display = type === 'FILE' ? 'block' : 'none';
            if (urlInput) urlInput.style.display = type === 'LINK' ? 'block' : 'none';
            if (textInput) textInput.style.display = type === 'TEXT' ? 'block' : 'none';
          });
        }

        // Handle resource form submission
        const addResourceForm = document.getElementById('addResourceForm');
        if (addResourceForm) {
          addResourceForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData();
            const titleInput = document.getElementById('title');
            const descriptionInput = document.getElementById('description');
            const resourceTypeInput = document.getElementById('resourceType');
            const coursesSelect = document.getElementById('courses');
            
            if (!titleInput || !descriptionInput || !resourceTypeInput || !coursesSelect) {
              showToast('Required form elements are missing', 'error');
              return;
            }
            
            formData.append('title', titleInput.value);
            formData.append('description', descriptionInput.value);
            formData.append('resource_type', resourceTypeInput.value);
            
            const courses = Array.from(coursesSelect.selectedOptions)
              .map(option => option.value);
            if (courses.length === 0) {
              showToast('Please select at least one course', 'error');
              return;
            }
            courses.forEach(course => formData.append('courses[]', course));
            
            const resourceType = resourceTypeInput.value;
            if (resourceType === 'FILE') {
              const fileInput = document.getElementById('file');
              if (fileInput && fileInput.files.length > 0) {
                formData.append('file', fileInput.files[0]);
              } else {
                showToast('Please select a file', 'error');
                return;
              }
            } else if (resourceType === 'LINK') {
              const urlInput = document.getElementById('contentUrl');
              if (urlInput && urlInput.value) {
                formData.append('content_url', urlInput.value);
              } else {
                showToast('Please enter a URL', 'error');
                return;
              }
            } else if (resourceType === 'TEXT') {
              const textInput = document.getElementById('contentText');
              if (textInput && textInput.value) {
                formData.append('content_text', textInput.value);
              } else {
                showToast('Please enter content', 'error');
                return;
              }
            }
            
            fetch('/api/resources', {
              method: 'POST',
              body: formData
            })
            .then(response => response.json())
            .then(result => {
              if (result.error) {
                showToast(result.error, 'error');
              } else {
                showToast('Resource added successfully', 'success');
                closeAddResourceModal();
                loadResources();
              }
            })
            .catch(error => {
              console.error('Error adding resource:', error);
              showToast('Error adding resource', 'error');
            });
          });
        }
      });

      // Handle resource type change and form submission
      document.addEventListener('DOMContentLoaded', function() {
        // Handle resource type change
        const resourceTypeSelect = document.getElementById('resourceType');
        if (resourceTypeSelect) {
          resourceTypeSelect.addEventListener('change', function(e) {
            const type = e.target.value;
            const fileInput = document.getElementById('fileInput');
            const linkInput = document.getElementById('linkInput');
            const textInput = document.getElementById('textInput');
            
            if (fileInput) fileInput.style.display = type === 'FILE' ? 'block' : 'none';
            if (linkInput) linkInput.style.display = type === 'LINK' ? 'block' : 'none';
            if (textInput) textInput.style.display = type === 'TEXT' ? 'block' : 'none';
          });
        }

        // Handle resource form submission
        const addResourceForm = document.getElementById('addResourceForm');
        if (addResourceForm) {
          addResourceForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData();
            const titleInput = document.getElementById('title');
            const descriptionInput = document.getElementById('description');
            const resourceTypeInput = document.getElementById('resourceType');
            const coursesSelect = document.getElementById('courses');
            
            if (!titleInput || !descriptionInput || !resourceTypeInput || !coursesSelect) {
              showToast('Required form elements are missing', 'error');
              return;
            }
            
            formData.append('title', titleInput.value);
            formData.append('description', descriptionInput.value);
            formData.append('resource_type', resourceTypeInput.value);
            
            const courses = Array.from(coursesSelect.selectedOptions)
              .map(option => option.value);
            if (courses.length === 0) {
              showToast('Please select at least one course', 'error');
              return;
            }
            courses.forEach(course => formData.append('courses[]', course));
            
            const resourceType = resourceTypeInput.value;
            if (resourceType === 'FILE') {
              const fileInput = document.getElementById('file');
              if (fileInput && fileInput.files.length > 0) {
                formData.append('file', fileInput.files[0]);
              } else {
                showToast('Please select a file', 'error');
                return;
              }
            } else if (resourceType === 'LINK') {
              const urlInput = document.getElementById('contentUrl');
              if (urlInput && urlInput.value) {
                formData.append('content_url', urlInput.value);
              } else {
                showToast('Please enter a URL', 'error');
                return;
              }
            } else if (resourceType === 'TEXT') {
              const textInput = document.getElementById('contentText');
              if (textInput && textInput.value) {
                formData.append('content_text', textInput.value);
              } else {
                showToast('Please enter content', 'error');
                return;
              }
            }
            
            fetch('/api/resources', {
              method: 'POST',
              body: formData
            })
            .then(response => response.json())
            .then(result => {
              if (result.error) {
                showToast(result.error, 'error');
              } else {
                showToast('Resource added successfully', 'success');
                closeAddResourceModal();
                loadResources();
              }
            })
            .catch(error => {
              console.error('Error adding resource:', error);
              showToast('Error adding resource', 'error');
            });
          });
        }

        // Load resources when section is shown
        const resourcesButton = document.querySelector('button[onclick="showSection(\'resources\', this)"]');
        if (resourcesButton) {
          resourcesButton.addEventListener('click', loadResources);
        }
      });

      // Function to toggle resource inputs
      function toggleResourceInputs() {
        const resourceType = document.getElementById('resourceType')?.value;
        const fileInput = document.getElementById('fileInput');
        const linkInput = document.getElementById('linkInput');
        const textInput = document.getElementById('textInput');
        
        if (fileInput) fileInput.style.display = resourceType === 'FILE' ? 'block' : 'none';
        if (linkInput) linkInput.style.display = resourceType === 'LINK' ? 'block' : 'none';
        if (textInput) textInput.style.display = resourceType === 'TEXT' ? 'block' : 'none';
      }

      // Add this function to load top students
      function loadTopStudents() {
        fetch('/staff/top_students')
          .then(response => response.json())
          .then(students => {
            const topStudentsList = document.getElementById('topStudentsList');
            topStudentsList.innerHTML = '';
            
            students.forEach((student, index) => {
              const studentElement = document.createElement('div');
              studentElement.className = 'top-student-item';
              studentElement.innerHTML = `
                <div class="top-student-rank">#${index + 1}</div>
                <div class="top-student-info">
                  <div class="top-student-name">${student.student_name}</div>
                  <div class="top-student-course">${student.course}</div>
                </div>
                <div class="top-student-sitins">
                  ${student.total_sitins} sit-ins
                </div>
              `;
              topStudentsList.appendChild(studentElement);
            });
          })
          .catch(error => {
            console.error('Error loading top students:', error);
            showToast('Error loading top students', 'error');
          });
      }

      // Add this to your existing loadStatistics function
      function loadStatistics() {
        // ... existing statistics loading code ...
        
        // Load top students
        loadTopStudents();
      }
    </script>
  </body>
</html>
