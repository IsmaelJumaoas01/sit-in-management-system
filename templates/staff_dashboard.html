<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Staff Dashboard</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='staff_dashboard.css') }}"
    />
  </head>

  <body>
    <!-- Navbar -->
    <header class="navbar">
      <div class="navbar-container">
        <a href="{{ url_for('user.dashboard') }}" class="navbar-logo">ADMIN</a>
        <div class="navbar-icons">
          <form action="{{ url_for('auth.logout') }}" method="post">
            <button type="submit" class="navbar-button logout-button">
              Logout
            </button>
          </form>
        </div>
      </div>
    </header>

    <div class="main-container">
      <!-- Left Panel -->
      <div class="left-panel">
        <h1>Welcome, {{ staff_firstname }} {{ staff_lastname }}</h1>
        <div class="info-box">
          <p><strong>Email:</strong> {{ staff_email }}</p>
          <p><strong>Role:</strong> Staff</p>
        </div>
        <div class="button-container">
          <button class="button" onclick="showSection('announcements', this)">
            Announcements
          </button>

          <button class="button" onclick="showSection('viewRequests', this)">
            View Requests
          </button>
          <button class="button" onclick="showSection('manageSitins', this)">
            Manage Sit-ins
          </button>
          <button class="button" onclick="showSection('searchStudent', this)">
            Search Student
          </button>
          <button class="button" onclick="showSection('viewSchedules', this)">
            View Schedules
          </button>
          <button class="button" onclick="showSection('manageLabs', this)">
            Manage Laboratories
          </button>
        </div>
      </div>

      <!-- Right Panel -->
      <div class="right-panel">
        <!-- Right Panel: Announcements Section -->
        <div id="announcements" class="content-section" style="display: none">
          <h2>Announcements</h2>
          <!-- Form to add announcement -->
          <form
            id="announcementForm"
            class="search-form"
            onsubmit="event.preventDefault(); addAnnouncement();"
          >
            <input
              type="text"
              id="announcementTitle"
              placeholder="Title"
              required
            />
            <textarea
              id="announcementContent"
              placeholder="Content"
              required
            ></textarea>
            <button type="submit">Post Announcement</button>
          </form>
          <!-- Container for announcements list -->
          <div id="announcementList" class="data-container"></div>
          <!-- Pagination Controls -->
          <div id="announcementPagination" class="pagination"></div>
        </div>

        <!-- Edit Announcement Modal -->
        <div id="editAnnouncementModal" class="modal">
          <div class="modal-content">
            <div class="modal-header">
              <h3>Edit Announcement</h3>
              <span class="close-modal" onclick="closeEditModal()"
                >&times;</span
              >
            </div>
            <div class="modal-body">
              <input
                type="text"
                id="editAnnouncementTitle"
                placeholder="Title"
                required
              />
              <textarea
                id="editAnnouncementContent"
                placeholder="Content"
                required
              ></textarea>
              <button onclick="updateAnnouncement()">Save</button>
            </div>
          </div>
        </div>

        <div id="viewRequests" class="content-section">
          <h2>Service Requests</h2>
          <div class="data-container">
            <p>Here you can view and manage student service requests.</p>
            <!-- Pagination controls -->
            <div class="pagination">
              <button class="prev-button" onclick="prevPage('viewRequests')">
                Previous
              </button>
              <button class="next-button" onclick="nextPage('viewRequests')">
                Next
              </button>
            </div>
          </div>
        </div>

        <!-- Search Student Section -->
        <div id="searchStudent" class="content-section" style="display: none">
          <h2>Search Student</h2>
          <!-- Search Form -->
          <form
            id="searchStudentForm"
            class="search-form"
            onsubmit="event.preventDefault(); searchStudent();"
          >
            <input
              type="text"
              id="studentSearchInput"
              placeholder="Enter Student ID"
              required
            />
            <button type="submit">Search</button>
          </form>
          <!-- Results Container -->
          <div id="studentResults" class="data-container"></div>
        </div>

        <div id="manageSitins" class="content-section" style="display: none">
          <h2>Student Sit-in Requests</h2>
          <div class="data-container">
            <p>Manage student sit-in requests and approve them.</p>
            <!-- Pagination controls -->
            <div class="pagination">
              <button class="prev-button" onclick="prevPage('manageSitins')">
                Previous
              </button>
              <button class="next-button" onclick="nextPage('manageSitins')">
                Next
              </button>
            </div>
          </div>
        </div>

        <div id="viewSchedules" class="content-section" style="display: none">
          <h2>Class Schedules</h2>
          <div class="data-container">
            <p>View and manage class schedules for laboratories.</p>
            <!-- Pagination controls -->
            <div class="pagination">
              <button class="prev-button" onclick="prevPage('viewSchedules')">
                Previous
              </button>
              <button class="next-button" onclick="nextPage('viewSchedules')">
                Next
              </button>
            </div>
          </div>
        </div>

        <div id="manageLabs" class="content-section" style="display: none">
          <h2>Manage Laboratories</h2>
          <form id="addLabForm">
            <input type="number" id="labId" placeholder="Lab ID" required />
            <input
              type="number"
              id="totalComputers"
              placeholder="Total Computers"
              required
            />
            <button type="submit">Add Laboratory</button>
          </form>
          <div class="data-container">
            <ul id="labList"></ul>
            <!-- Pagination controls -->
            <div class="pagination">
              <button class="prev-button" onclick="prevPage('manageLabs')">
                Previous
              </button>
              <button class="next-button" onclick="nextPage('manageLabs')">
                Next
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      let currentPage = {
        viewRequests: 1,
        manageSitins: 1,
        viewSchedules: 1,
        manageLabs: 1,
      };
      const itemsPerPage = 5;

      function showSection(sectionId, button) {
        document
          .querySelectorAll(".content-section")
          .forEach((section) => (section.style.display = "none"));
        document.getElementById(sectionId).style.display = "block";
        document
          .querySelectorAll(".button")
          .forEach((btn) => btn.classList.remove("selected"));
        button.classList.add("selected");
        fetchLabs();
      }

      document.addEventListener("DOMContentLoaded", function () {
        showSection("viewRequests", document.querySelector(".button"));
        fetchLabs();
      });

      document
        .getElementById("addLabForm")
        .addEventListener("submit", function (event) {
          event.preventDefault();
          const labId = document.getElementById("labId").value.trim();
          const totalComputers = parseInt(
            document.getElementById("totalComputers").value.trim(),
            10
          );

          if (!totalComputers || totalComputers <= 0) {
            alert("Please enter a valid number of computers.");
            return;
          }

          fetch("/manage_labs", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              lab_id: labId ? parseInt(labId, 10) : null,
              total_computers: totalComputers,
            }),
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.error) {
                alert(data.error);
              } else {
                document.getElementById("labId").value = "";
                document.getElementById("totalComputers").value = "";
                fetchLabs();
              }
            });
        });

      function fetchLabs() {
        fetch("/manage_labs")
          .then((response) => response.json())
          .then((labs) => {
            const labList = document.getElementById("labList");
            labList.innerHTML = "";
            const start = (currentPage.manageLabs - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const paginatedLabs = labs.slice(start, end);
            paginatedLabs.forEach((lab) => {
              const li = document.createElement("li");
              li.innerHTML = `Lab ID: ${lab.LAB_ID} - ${lab.TOTAL_COMPUTERS} Computers 
                        <button onclick="confirmDeleteLab(${lab.LAB_ID})">Delete</button>`;
              labList.appendChild(li);
            });
          });
      }

      function confirmDeleteLab(labId) {
        if (
          confirm(
            "Are you sure you want to delete this lab and all its computers?"
          )
        ) {
          deleteLab(labId);
        }
      }

      function deleteLab(labId) {
        fetch("/manage_labs", {
          method: "DELETE",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ lab_id: labId }),
        })
          .then((response) => response.json())
          .then(() => fetchLabs());
      }

      function prevPage(sectionId) {
        if (currentPage[sectionId] > 1) {
          currentPage[sectionId]--;
          fetchLabs();
        }
      }

      function nextPage(sectionId) {
        currentPage[sectionId]++;
        fetchLabs();
      }

      function searchStudent() {
        const searchQuery = document
          .getElementById("studentSearchInput")
          .value.trim();
        const resultsContainer = document.getElementById("studentResults");
        resultsContainer.innerHTML = "";

        if (searchQuery === "") {
          resultsContainer.innerHTML = "<p>Please enter a Student ID.</p>";
          return;
        }

        // Call the route that uses the student ID as a URL parameter
        fetch(`/search_student/${encodeURIComponent(searchQuery)}`)
          .then((response) => response.json())
          .then((data) => {
            if (!data || data.length === 0) {
              resultsContainer.innerHTML =
                "<p style='color: red;'>No student found matching that ID.</p>";
            } else {
              const table = document.createElement("table");
              table.className = "student-table"; // Apply custom styling
              table.innerHTML = `
          <tr>
            <th>Student ID</th>
            <th>Name</th>
            <th>Email</th>
            <th>Course</th>
            <th>Year</th>
          </tr>
        `;
              data.forEach((student) => {
                const row = document.createElement("tr");
                row.innerHTML = `
            <td>${student.IDNO}</td>
            <td>${student.NAME}</td>
            <td>${student.EMAIL}</td>
            <td>${student.COURSE}</td>
            <td>${student.YEAR}</td>
          `;
                table.appendChild(row);
              });
              resultsContainer.appendChild(table);
            }
          })
          .catch((error) =>
            console.error("Error fetching student data:", error)
          );
      }

      function handleEnter(event) {
        if (event.key === "Enter") {
          event.preventDefault();
          searchStudent();
        }
      }

      let announcementCurrentPage = 1;
      const announcementsPerPage = 5;
      let currentAnnouncementId = null; // To store the id of the announcement being edited

      function fetchAnnouncements() {
        fetch("/announcements")
          .then((response) => response.json())
          .then((data) => {
            const listContainer = document.getElementById("announcementList");
            const paginationContainer = document.getElementById(
              "announcementPagination"
            );
            listContainer.innerHTML = "";
            paginationContainer.innerHTML = "";

            if (!data || data.length === 0) {
              listContainer.innerHTML = "<p>No announcements posted.</p>";
              return;
            }

            // Calculate pagination
            const totalAnnouncements = data.length;
            const totalPages = Math.ceil(
              totalAnnouncements / announcementsPerPage
            );
            if (announcementCurrentPage > totalPages) {
              announcementCurrentPage = totalPages;
            }
            const start = (announcementCurrentPage - 1) * announcementsPerPage;
            const end = start + announcementsPerPage;
            const pageAnnouncements = data.slice(start, end);

            // Build announcement cards
            pageAnnouncements.forEach((announcement) => {
              const div = document.createElement("div");
              div.className = "announcement-item";
              div.innerHTML = `
          <h3>${announcement.title}</h3>
          <p>${announcement.content}</p>
          <small>Posted on: ${announcement.date_posted} by ${
                announcement.posted_by
              }</small>
          <div class="announcement-actions">
            <button onclick="openEditModal(${
              announcement.announcement_id
            }, '${encodeURIComponent(
                announcement.title
              )}', '${encodeURIComponent(announcement.content)}')">Edit</button>
            <button onclick="deleteAnnouncement(${
              announcement.announcement_id
            })">Delete</button>
          </div>
        `;
              listContainer.appendChild(div);
            });

            // Build pagination controls
            if (totalPages > 1) {
              const prevBtn = document.createElement("button");
              prevBtn.textContent = "Previous";
              prevBtn.onclick = () => {
                if (announcementCurrentPage > 1) {
                  announcementCurrentPage--;
                  fetchAnnouncements();
                }
              };
              const nextBtn = document.createElement("button");
              nextBtn.textContent = "Next";
              nextBtn.onclick = () => {
                if (announcementCurrentPage < totalPages) {
                  announcementCurrentPage++;
                  fetchAnnouncements();
                }
              };
              paginationContainer.appendChild(prevBtn);
              paginationContainer.appendChild(
                document.createTextNode(
                  ` Page ${announcementCurrentPage} of ${totalPages} `
                )
              );
              paginationContainer.appendChild(nextBtn);
            }
          })
          .catch((error) =>
            console.error("Error fetching announcements:", error)
          );
      }

      function addAnnouncement() {
        const title = document.getElementById("announcementTitle").value.trim();
        const content = document
          .getElementById("announcementContent")
          .value.trim();
        if (title === "" || content === "") {
          alert("Title and content are required.");
          return;
        }
        fetch("/announcements", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ title, content }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.error) {
              alert(data.error);
            } else {
              document.getElementById("announcementTitle").value = "";
              document.getElementById("announcementContent").value = "";
              announcementCurrentPage = 1;
              fetchAnnouncements();
            }
          })
          .catch((error) =>
            console.error("Error posting announcement:", error)
          );
      }

      function openEditModal(id, encodedTitle, encodedContent) {
        currentAnnouncementId = id;
        // Decode the title and content before displaying
        document.getElementById("editAnnouncementTitle").value =
          decodeURIComponent(encodedTitle);
        document.getElementById("editAnnouncementContent").value =
          decodeURIComponent(encodedContent);
        document.getElementById("editAnnouncementModal").style.display =
          "block";
      }

      function closeEditModal() {
        document.getElementById("editAnnouncementModal").style.display = "none";
        currentAnnouncementId = null;
      }

      function updateAnnouncement() {
        const title = document
          .getElementById("editAnnouncementTitle")
          .value.trim();
        const content = document
          .getElementById("editAnnouncementContent")
          .value.trim();
        if (title === "" || content === "") {
          alert("Title and content are required.");
          return;
        }
        fetch(`/announcements/${currentAnnouncementId}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ title, content }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.error) {
              alert(data.error);
            } else {
              closeEditModal();
              fetchAnnouncements();
            }
          })
          .catch((error) =>
            console.error("Error updating announcement:", error)
          );
      }

      function deleteAnnouncement(id) {
        if (!confirm("Are you sure you want to delete this announcement?"))
          return;
        fetch(`/announcements/${id}`, {
          method: "DELETE",
          headers: { "Content-Type": "application/json" },
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.error) {
              alert(data.error);
            } else {
              fetchAnnouncements();
            }
          })
          .catch((error) =>
            console.error("Error deleting announcement:", error)
          );
      }

      // When the announcements section is shown, fetch announcements.
      function showSection(sectionId, button) {
        document
          .querySelectorAll(".content-section")
          .forEach((section) => (section.style.display = "none"));
        document.getElementById(sectionId).style.display = "block";
        document
          .querySelectorAll(".button")
          .forEach((btn) => btn.classList.remove("selected"));
        button.classList.add("selected");
        if (sectionId === "manageLabs") {
          fetchLabs();
        } else if (sectionId === "announcements") {
          announcementCurrentPage = 1;
          fetchAnnouncements();
        }
      }

      document.addEventListener("DOMContentLoaded", function () {
        // Show default section (for example, viewRequests)
        showSection("viewRequests", document.querySelector(".button"));
      });
    </script>
  </body>
</html>
